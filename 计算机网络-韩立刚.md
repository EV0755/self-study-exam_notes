课程介绍:

课程目标：
理解数据通信的过程和TCP、IP协议的工作过程。
适用人群：
将来从事IT工作的人群，打算彻底从理论上搞明白计算机网络是如何通信的人群。

课程大纲-2019全新《计算机网络原理》考研视频教程

资料下载



# 第1章 计算机网络和协议

6小时43分钟30节

高端IT运维职位需要学习的技能 04:40 

1.1  计算机网络在当今社会的作用

## 1.2  认识网络

![image-20210506175056082](计算机网络-韩立刚.assets/image-20210506175056082.png)



- 家庭ADSL无线拨号路由器逻辑图

  ![image-20210506175044107](计算机网络-韩立刚.assets/image-20210506175044107.png)

  

## 1.3  理解计算机通信使用的协议

![image-20210504021329444](计算机网络-韩立刚.assets/image-20210504021329444.png)



### 1-3 抓包分析应用层协议 12:37 

![image-20210504174335974](计算机网络-韩立刚.assets/image-20210504174335974.png)



### 1-4 协议标准化的好处 10:04 

- 互联网中有很多常见的应用，很多家公司开发服务端程序，也有很多家公司开发客户端程序。为了使不同厂家开发的服务端程序和客户端程序能够通信 ，必须将这些应用程序通信协议的协议进行标准化

- TCP/IP协议组中知名的应用层协议
  ◼ 超级文本传输协议--HTTP ，用于访问Web 服务。
  ◼ 安全的超级文本传输协议--HTTPS ，能够将HTTP 协议通信进行加密访问。
  ◼ 简单邮件传输协议--SMTP ，用于发送电子邮件。
  ◼ 邮局协议版本3 --POP3 ，用于接收电子邮件。
  ◼ 域名解析协议--DNS ，用于域名解析。
  ◼ 文件传输协议--FTP ，用于在Internet 上传和下载文件。
  ◼ 简单文件传输协议--TFTP ，在客户机与服务器之间进行简单文件传输的协议。
  ◼ 远程登录--telnet 协议，用于远程配置网络设备和Linux 系统。
  ◼ 动态主机配置协议--DHCP ，用于计算机自动请求IP



### 1-5 以HTTP协议为例理解计算机通信协议 05:55 

- **HTTP 协议的甲方乙方分别是**
  Web 服务器和浏览器
  ◼ 该协议就是规定浏览器访问网站方法和规则。
  ◼ 定义了客户端能够向服务器发送哪些请求。
  ◼ 服务器能够向客户端发送哪些响应。
  ◼ 定义了请求报文格式。
  ◼ 定义了响应报文格式。

- **计算机通信使用的协议包含三要素**
  计算机通信使用的协议包含三要素：语法、语义和同步。
  - 语法
    - 定义协议中每种报文的格式：有哪些字段，字段是定长还是变长，如果是变长，字段分割符是什么，都要在协议中定义。一个协议有可能需要定义多种报文格式，比如ICMP 协议，定义了ICMP 请求报文格式、ICMP 响应报文格式、ICMP 差错报告报文格式。
  - 语义
    - 客户端能够向服务器发送那些请求（方法或命令），服务器有哪些响应（状态代码），每种状态代码代表什么意思。
  - 同步
    - 客户端访和服务器命令交互顺序，比如POP3 协议，需要先验证用户身份才能收邮件。

![image-20210504230821305](计算机网络-韩立刚.assets/image-20210504230821305.png)

![image-20210504230834336](计算机网络-韩立刚.assets/image-20210504230834336.png)



## 1.4 TCP/IP 协议

### 1-6 TCP/IP协议体系结构 17:17 

![image-20210504230912600](计算机网络-韩立刚.assets/image-20210504230912600.png)

![image-20210504230927543](计算机网络-韩立刚.assets/image-20210504230927543.png)

![image-20210504230943120](计算机网络-韩立刚.assets/image-20210504230943120.png)

![image-20210504230956577](计算机网络-韩立刚.assets/image-20210504230956577.png)

![image-20210504231012082](计算机网络-韩立刚.assets/image-20210504231012082.png)



### 1-20 TCP/IP协议通信过程 28:15 

![image-20210505173454852](计算机网络-韩立刚.assets/image-20210505173454852.png)





## 1.5 OSI 参考模型

### 1-7 OSI参考模型和TCP/IP协议之间的关系 05:51 

![image-20210504233800655](计算机网络-韩立刚.assets/image-20210504233800655.png)

### 1.5.2 **OSI参考模型每层功能**

◼  应用层 ，根据互联网中需要通信的应用程序的功能，定义客户端和服务端程序通信的规范，应用层向表示层发出请求。
◼  表示层，定义数据格式、是否加密或压缩。例如，FTP 允许你选择以二进制或ASCII 格式传输。如果选择二进制，那么发送方和接收方不改变文件的内容。如果选择ASCII 格式，发送方将把文本从发送方的字符集转换成标准的ASCII 后发送数据。在接收方将标准的ASCII 转换成接收方计算机的字符集。
◼  会话层 ，它定义了如何开始、控制和结束一个会话，包括对多个双向消息的控制和管理，以便在只完成连续消息的一部分时可以通知应用，从而使表示层看到的数据是连续的。
◼  传输层 ，常规数据递送，面向连接或无连接。面向连接实现可靠传输，比如TCP 协议，面向无连接，提供不可靠传输，比如UDP 协议。
◼  网络层 ，根据网络地址为数据包选择选择转发路径。网络层为传输层提供服务，只是尽力转发数据包，不保证不丢包，也不保证按顺序到达接收端。
◼  数据链路层 ，数据链路层常简称链路层，两台主机之间的数据传输，总是在一段一段的链路上传送的，这就需要专门的链路层的协议。
◼  物理层 ，在物理层上所传输的数据单位是比特。发送方发送1 （或0 ）时，接收方应该收到1 （或0 ），而不是0 （或1 ）。因此物理层要考虑用多大电压代表“1 ”或“0 ”，以及接收方如何识别出发送方所代表的比特。物理层还要确定连接电缆的的插头应当有多少根引脚以及各条引脚应如何连接。



![image-20210505163555273](计算机网络-韩立刚.assets/image-20210505163555273.png)

### 1.6.6 用分层的思想考虑问题

◼ 计算机通信按功能分层的好处就是当某一层有变换不会波及其他层。
◼ 比如单位的网络IP 地址重新规划，不会影响企业内外的服务的访问。
◼ 要实现这个分层，就不要在应用层包含网络层的信息，比如开发的客户端程序连接服务器就不要写服务器的IP 地址，而是写服务器的名称。如果将服务器的IP 地址写进应用程序，就没有采纳OSI 参考模型的分层思想。网络一旦调整，就需要修改客户端程序。这就是网络层变换引起应用层变化了。

### 1-15 网络层功能 07:25 

![image-20210505164002171](计算机网络-韩立刚.assets/image-20210505164002171.png)

![image-20210505163504216](计算机网络-韩立刚.assets/image-20210505163504216.png)



1-16 数据链路层功能 07:31 

1-17 物理层功能 06:57 



### 1-18 OSI参考模型指导网络排错 31:25 

![image-20210505163632982](计算机网络-韩立刚.assets/image-20210505163632982.png)



### 1-21 集线器交换机路由工作在哪一层？ 07:29 

![image-20210505223012038](计算机网络-韩立刚.assets/image-20210505223012038.png)





## 1.7  计算机网络性能指标

### 1.7.1 速率

- 网络技术中的速率指的是每秒钟传输的比特数量，称为数据率（data rate ）或比特率（bit
  rate ），速率的单位为b/s （比特每秒）或bit/s ，有时也写为bps ，即bit per second 。当速率较高时，就可以用kb/s （k=103= 千）、Mb/s （M=106= 兆）、Gb/s （G=109= 吉）或Tb/s（T=1012= 太）。现在人们习惯于用更简洁但不严格的说法来描述速率，比如10M 网速，而省略了单位中的b/s。 。
  ◼Windows 操作系统中，速率以字节为单位。大写的B 代表字节，是byte 的缩写，8 比特=1 字节。
  ◼ 速率是指的一个发端一个接收端平均每秒中发送多少bit。

### 1.7.2 带宽

- 在计算机网络中，带宽用来表示网络通信线路传输数据的能力，即最高速率。
- 可以设置电脑网卡的带宽。

### 1.7.3 吞吐量

- 吞吐量表示在单位时间内通过某个网络或接口的数据量，包括全部上传和下载的流量。

### 1.7.4 时延

- 时延（delay 或latency ）是指数据（一个数据包或bit ）从网络的一端传送到另一端所需要的时间。时延是一个很重要的性能指标，有时也称为延迟或迟延。

1. **发送时延（transmission delay ）**是主机或路由器发送数据帧所需时间，也就是从发送数据帧的第一个比特开始，到该帧最后一个比特发送完毕所需要的时间。下图

   ![image-20210506175624265](计算机网络-韩立刚.assets/image-20210506175624265.png)

   ![image-20210506175631938](计算机网络-韩立刚.assets/image-20210506175631938.png)

2. **传播时延（propagation delay）**是电磁波在信道中传播一定的距离需要花费的时间。如 下图所示，从最后一比特发送完毕到最后一比特到达路由器接口需要的时间就是传播时延。

   ![image-20210506175710730](计算机网络-韩立刚.assets/image-20210506175710730.png)

3. **排队时延**

   - 分组在经过网络传输时，要经过许多的路由器。但分组在进入路由器后要先在输入队列中排队等待处理。

4. **处理时延**

   - 路由器或主机在收到数据包时，要花费一定时间进行处理，例如分析数据包的首部、进行首部差错检验，查找路由表为数据包选定转发出口，这就产生了处理时延。
   - 数据在网络中经历的总时延就是以上四种时延的总和。
   - 总时延= 发送时延+ 传播时延+ 处理时延+ 排队时延

### 1.7.5 时延带宽积

- 把链路上的传播时延和带宽相乘，就会得到时延带宽积。这对我们以后计算以太网的最短帧非常有帮助。

- 时延带宽积= 传播时延×带宽

  ![image-20210506175811817](计算机网络-韩立刚.assets/image-20210506175811817.png)

  

### 1.7.6 往返时间

- 在计算机网络中，往返时间RTT（ Round-Trip Time ）也是一个重要的性能指标，它表示从发送端发送数据开始，到发送端接收到来自接收端的确认（发送端收到后立即发送确认），总共经历的时间。
- 往返时间带宽积，可以用来计算当发送端连续发送数据时，接收端如发现有错误，立即向发送端发送通知使发送端停止，发送端这段时间发送的比特量 。

### 1.7.7 利用率

- 利用率是指网络有百分之几的时间是被利用的（有数据通过），没有数据通过的网络利用率为零。网络利用率越高，数据分组在路由器和交换机处理时就需要排队等待，因此时延也就越大。下面的公式表示网络利用率和延迟之间的关系。

![image-20210506175900746](计算机网络-韩立刚.assets/image-20210506175900746.png)



## 1.8  网络分类

### 1.8.1 按网络的范围进行分类

1. 局域网（Local Area Network ，LAN ）是在一个局部的地理范围内（如一个学校、
   工厂和机关内），一般是方圆几千米以内，将各种计算机、外部设备和数据库等
   互相连接起来组成的计算机通信网。
2. 广域网（Wide Area Network ，WAN ）通常跨接很大的物理范围，所覆盖的范围从
   几十公里到几千公里，能连接多个城市或国家，或横跨几个洲并能提供远距离通
   信，形成国际性的远程网络。
3. 城域网（Metropolitan Area Network ，MAN ）的作用范围一般是一个城市，可跨
   越几个街区甚至整个城市，其作用距离约为5 ～50km 。城域网可以为一个或几个
   单位所拥有，但也可以是一种公用设施，用来将多个局域网进行互连。目前很多
   城域网采用的是以太网技术，因此有时也将其并入局域网的范围进行讨论。
4. 个人区域网（Personal Area Network ，PAN ）就是在个人工作的地方把属于个人使
   用的电子设备（如便携式电脑等）用无线技术连接起来的网络，因此也常称为无
   线个人区域网（Wireless PAN ，WPAN ），比如无线路由器组建的家庭网络，就是
   一个PAN

### 1.8.2 按网络的使用者进行分类

1. 公用网（public network ）是指电信公司（国有或私有）出资建造的大型网络。“公用”的意思就是所有愿意按电信公司的规定交纳费用的人都可以使用这种网络。因此公用网也可称为公众网，因特网就是全球最大的公用网络。
2. 专用网（private network ）是某个部门为本单位的特殊业务工作需要而建造的网络。这种网络不向本单位以外的人提供服务。例如，军队、铁路、电力等系统均有本系统的专用网。
3. 公用网和专用网都可以传送多种业务。如传送的是计算机数据，则分别是公用计算机网络和专用计算机网络。

## 1.9 企业局域网设计

### 1.9.1 二层结构的局域网

- 接入层连接计算机

- 汇聚成连接接入层交换

  ![image-20210506180034187](计算机网络-韩立刚.assets/image-20210506180034187.png)

  

### 1.9.2 三层结构的局域网

- 接入层
- 汇聚层
- 核心层

![image-20210506180100106](计算机网络-韩立刚.assets/image-20210506180100106.png)



# 第2章 物理层

4小时29分钟15节

## 2.1  物理层的基本概念

- 物理层涉及到的内容

  ![image-20210506165100529](计算机网络-韩立刚.assets/image-20210506165100529.png)

  物理层涉及到的知识点
  数字信号 双绞线 同轴电缆 光纤 时分多路 波分复用 编码方式
  模拟信号 频分多路复用 码分复用技术 全双工 半双工 单工通信

- **物理层实现的功能** 12:13 
  - **物理层定义了与传输媒体的接口有关的一些特性。**
    1. 机械特性 外形
    2. 电气特性 电压
    3. 功能特性 功能
    4. 过程特性 时序、顺序

## 2.2  数据通信基础

信息-数据-信号 26:53 

数字信号和模拟信号 08:47 

### 2.2.1  数据通信模型

1. 局域网通信模型

   ![image-20210506171858622](计算机网络-韩立刚.assets/image-20210506171858622.png)

2. 广域网通信模型

   ![image-20210506171909197](计算机网络-韩立刚.assets/image-20210506171909197.png)

3. 广域网通信模型

   ![image-20210506171919371](计算机网络-韩立刚.assets/image-20210506171919371.png)

   

### 2.2.2  数据通信一些常用术语

- 信息（Message ）：通信的目的是传送信息，如文字、图像、视频和音频等都是消息。
- 数据（Data ）：信息在传输之前需要进行编码，编码后的信息就变成数据。
- 信号（signal ）：数据在通信线路上传递需要变成电信号或光信号。

![image-20210506171934813](计算机网络-韩立刚.assets/image-20210506171934813.png)



### 2.2.3  模拟信号和数字信号

- 模拟信号或连续信号

  ![image-20210506171950364](计算机网络-韩立刚.assets/image-20210506171950364.png)

- 数字信号或离散信号

  -   **二进制码元**

    - 一个码元表示一个二进制数。

    ![image-20210506172054869](计算机网络-韩立刚.assets/image-20210506172054869.png)

  - **四进制码元**

    - 一个码元代表两位二进制数。

    ![image-20210506172040101](计算机网络-韩立刚.assets/image-20210506172040101.png)

  - **八进制码元**

    - 一个码元代表三位二进制数。

    ![image-20210506172030677](计算机网络-韩立刚.assets/image-20210506172030677.png)

- 数字信号和模拟信号优缺点

  - 模拟信号在传输过程中如果出现信号干扰发生波形发生变形，很难纠正。

    ![image-20210506172145250](计算机网络-韩立刚.assets/image-20210506172145250.png)

  - 数字信号 波形失真可以修复

    ![image-20210506172154555](计算机网络-韩立刚.assets/image-20210506172154555.png)

  

### 2.2.4  模拟信号转换成数字信号

- 模拟信号可以转换成数字信号，转换过程有失真。所以听歌还要去演唱会现场，100% 的音效。使用电脑听的音乐是转换成数字信号后再还原成模拟信号，就达不到现场效果了。

  ![image-20210506172208295](计算机网络-韩立刚.assets/image-20210506172208295.png)

- 采样频率和采样精度决定音乐的品质

  ![image-20210506172222829](计算机网络-韩立刚.assets/image-20210506172222829.png)



## 2.3  信道和调制

信道复用技术 10:57 

调制技术-基带调制和带通调制 19:37 

信道极限容量-码元的最高传输速率（奈氏准则） 16:43 

信道极限容量-最高数据传输速率（香农公式） 21:16 

### 2.3.1  信道

- 信道（Channel ）是信息传输的通道，即信息进行传输时所经过的一条通路，信道的一端是发送端，另一端是接收端。一条传输介质上可以有多条信道（多路复用）。

  ![image-20210506172247726](计算机网络-韩立刚.assets/image-20210506172247726.png)

  

### 2.3.2  单工和半双工以及全双工通信

1. **单向通信**
   - 又称为单工通信，即信号只能向一个方向传输，任何时候都不能改变信号的传送方向。无线电广播或有线电视广播就是单工通信，信号只能是广播电台发送，收音机接收。
2. **双向交替通信**
   - 又称半双工通信，信号可以双向传送，但是必须是交替进行，一个时间只能向一个方向传。有些对讲机就是用半双工通信，A 端说话B 端接听，B 端说话A端接听，不能同时说和听。
3. **双向同时通信**
   - 又称全双工通信，即信号可以同时双向传送。比如我们手机打电话，听和说可以同时进行。

### 2.3.3  调制

- 来自信源的信号通常称为基带信号（即基本频带信号）。

- 调制可以分为两大类。

  - 一类仅仅对**基带信号的波形进行变换**，使它能够与信道特性相适应。变化后的信号仍然是基带信号，这类调制称为**基带调制**。由于这种基带调制十八数字信号转换成另一种形式的数字信号，因此大家更愿意把这种过程称为**编码（coding）** 
  - 另一类则需要使用**载波（carrier ）**进行调制，把基带信号的频率范围搬移到较高的频段以便在信道中传输 ， 经过载波调制后的信号称为带通信号（即仅在一段频率范围内能够通过信道），而使用载波的调制称为**带通调制**。

- 来自信源的信号通常称为基带信号（即基本频带信号） 。

- 为了把基带信号能够再介质中传输需要对基带信号进行调制。

  <img src="计算机网络-韩立刚.assets/image-20210506172401524.png" alt="image-20210506172401524" style="zoom: 67%;" /><img src="计算机网络-韩立刚.assets/image-20210506172338644.png" alt="image-20210506172338644" style="zoom:80%;" />

- 调制可以分为两大类。

  - **基带调制又称编码**
  - 将基带信号调制成模拟信号

- 常用**编码方式**

- 常用**带通调制**方法

### 2.3.4 信道极限容量

- 有失真但可识别

  ![image-20210506172704517](计算机网络-韩立刚.assets/image-20210506172704517.png)

- 失真太大无法识别

  ![image-20210506172715690](计算机网络-韩立刚.assets/image-20210506172715690.png)

- 信道带宽

  - 信道带宽= 能够通过的最高频率-最低频率

    ![image-20210506172732549](计算机网络-韩立刚.assets/image-20210506172732549.png)

- 模拟信号谐波成数字信号

  数字信号是由基波加上谐波叠加而成

  ![image-20210506172749814](计算机网络-韩立刚.assets/image-20210506172749814.png)

- 数字信号高频带宽不能通过

  ![image-20210506172843652](计算机网络-韩立刚.assets/image-20210506172843652.png)

- **奈氏准则 （数字信号）**

  - 在任何信道中，码元传输的速率是有上限的，否则就会出现码间串扰的问题，使接收端对
    码元的判决（即识别）成为不可能 。

  - 如果信道的频带越宽，也就是能够通过的信号高频分量越多，那么就可以使用更高速率传
    递码元而不出现码间串扰。

    **理想低通信道的最高码元传输速率=2WBaud**

    - W 是理想低通信道的带宽，单位为HZ。 
    - Baud 是波特，是码元传输速率的单位。

  - 使用奈氏准则给出的公式，可以根据信道的带宽，计算出码元的最高传输速率。

- 在码元传输速率一定的情况下提高数据传输速率

  - 码元传输速率一定，那就让一码元承载更多信息。8 进制码元，一码元代表三位二进制数，16 进制码元，一码元代表4 进制数。
  - 在工作电压一定的情况下，16 进制码元波形差别就小，更容易受干扰。
  - 要想增加码元之间的电压差别，那就要怎加工作电压，也就是提高发送信号的功率 。

  ![image-20210506172903385](计算机网络-韩立刚.assets/image-20210506172903385.png)

- **香农公式 （适用于模拟信号和数字信号）**

  - 有噪声的 信道的极限信息传输速率C：$C=W log _2 (1+S/N)\quad(b/s)$
  - 式中，W 为信道的带宽（以Hz 为单位）；S 为信道内所传信号的平均功率；N为信道内部的高斯噪声功率

- 信噪比

  - 所谓信噪比就是信号的平均功率和噪声的平均功率之比，常记为S/N ，并用分贝（dB ）作为度量单位。即：$信噪比（dB ）=10log _{10} (S/N)\quad(dB)$
  - 例如，当S/N=10 时，信噪比为10dB ，而当S/N=1000 时，信噪比为30dB 。



## 2.4  传输媒体

导向传输媒体 24:16 

非导向传输媒体 10:03 

### 2.4.1  导向传输媒体

- 导向传输媒体

  - 双绞线

    ![image-20210506172925707](计算机网络-韩立刚.assets/image-20210506172925707.png)

    ![image-20210506213902205](计算机网络-韩立刚.assets/image-20210506213902205.png)

    

  - 同轴电缆

    ![image-20210506172943315](计算机网络-韩立刚.assets/image-20210506172943315.png)

  - 光缆

    ![image-20210506173052882](计算机网络-韩立刚.assets/image-20210506173052882.png)

    ![image-20210506173009444](计算机网络-韩立刚.assets/image-20210506173009444.png)

    - 单一模光纤的光源要使用昂贵的半导体激光器，而不能使用较便宜的发光二极管。但单模光纤的衰耗较小，在2.5Gb/s 的高速率下可传输数十公里而不必采用中继器。

      ![image-20210506173029733](计算机网络-韩立刚.assets/image-20210506173029733.png)

    - 光纤不仅具有通信容量非常大的优点，而且还具有其他的一些特点 ：

      - 传输损耗小，中继距离长，对远距离传输特别经济。
      - 抗雷电和电磁干扰性能好。这在有大电流脉冲干扰的环境下尤为重要。
      - 无串音干扰，保密性好，也不易被窃听或截取数据。
      - 体积小，重量轻。

### 2.4.2  非引导型传输媒体

-  无线电频段

  ![image-20210506173105100](计算机网络-韩立刚.assets/image-20210506173105100.png)

  ![image-20210506214615299](计算机网络-韩立刚.assets/image-20210506214615299.png)

  

- 短波通信

  - 短波通信即高频通信，主要是靠电离层的反射。

- 微波通信

  - 微波在空间主要是直线传播

- 无线局域网
  要使用某一段无线电频谱进行通信，通常必须得到本国政府有关无线电频谱管理机构的许可证。
  但是，也有一些无线电频段是可以自由使用的（只要不干扰他人在这个频段中的通信），这正好满足计算无线局域网的需求 。



## 2.5  信道复用技术

频分复用 17:05 

时分复用和波分复用 15:35 

码分复用 27:33 

### 2.5.1 频分复用

1. 频分复用FDM （Frequency Division Multiplexing ）适合于模拟信号。

   ![image-20210506173300558](计算机网络-韩立刚.assets/image-20210506173300558.png)

   - A1 →A2 信道使用频率f1调制载波，B1 →B2 信道使用频率f2 调制载波，C1 →C2 信道使用频率f2调制载波，不同频率调制后的载波通过复用器将信号叠加后发送到信道。接收端的分用器将信号发送到三个滤波器，滤波器过滤出特定频率载波信号，再经过解调得到信源发送的模拟信号。

   ![image-20210506173335487](计算机网络-韩立刚.assets/image-20210506173335487.png)

   - 频分复用 FDM的例子
     - 电话线路就使用的频分复用

   ![image-20210506173404845](计算机网络-韩立刚.assets/image-20210506173404845.png)

   - 1路语音占用4kHz ，12 路语音信道形成一个组。5 个组形成一个超级组。可以看到频分复用可以进行多次叠加。

   ![image-20210506173501558](计算机网络-韩立刚.assets/image-20210506173501558.png)

   

### 2.5.2 时分复用

- 数字信号的传输更多使用时分复用（Time Division Multiplexing ，TDM） 技术。

  - 时分复用采用同一物理连接的不同时段来传输不同的信号，  时分复用则是将时间划分为一段段等长的时分复用帧（TDM 帧）。

  ![image-20210506173529366](计算机网络-韩立刚.assets/image-20210506173529366.png)

  ![image-20210506173545923](计算机网络-韩立刚.assets/image-20210506173545923.png)

- 统计时分复用，需要给没有给用户添加一个标记，接收端用来区分用户。

  - 交换机之间使用干道链路连接，可以通过多个VLAN 的帧，就是给每个VLAN 的帧添加帧标记。

  ![image-20210506173613602](计算机网络-韩立刚.assets/image-20210506173613602.png)

- 时分复用实现方法

  ![image-20210506173635366](计算机网络-韩立刚.assets/image-20210506173635366.png)

  

### 2.5.3 波分复用

- 光纤技术的应用使得数据的传输速率空前提高。目前一根单模光纤的传输速率可达到2.5Gb/s 。再提高传输速率就比较困难了 。 为了提高光纤的传输信号的速率，也可以进行频分复用，由于光载波的频率很高，因此习惯上用波长而不用频率来表示所使用的光载波。这样就得出了波分复用这一名词。

  ![image-20210506173658612](计算机网络-韩立刚.assets/image-20210506173658612.png)

  

### 2.5.4 码分复用

- 码分复用又称码分多址。是扩频通信技术（数字技术的分支）上发展起来的一种崭新而成熟的无线通信技术。

  ![image-20210506173716716](计算机网络-韩立刚.assets/image-20210506173716716.png)

- 假如基站发送了码片序列（0 0 -2 +2 0 -2 0 +2） ） 。
  ⚫ A 手机的码片序列为（-1 -1 -1 +1 +1 -1 +1 +1） ）
  ⚫ B 手机码片序列为（-1 -1 +1 -1 +1 +1 +1 -1） ）
  ⚫ C 手机码片序列为（-1 +1 -1 +1 +1 +1 -1 -1） ）
  ◼问这三个手机，分别收到了什么信号？

  ![image-20210506173755624](计算机网络-韩立刚.assets/image-20210506173755624.png)

- 码片正交

  - 什么是相互正交呢？两个不同站的码片序列正交，就是向量A  和B 的规格化内积（inner product） 都是0 ，令向量A 表示站A 的码片向量，令B  表示其他任何站的码片向量 。

    ![image-20210506173852252](计算机网络-韩立刚.assets/image-20210506173852252.png)

  - 码片序列，自己和自己的格式化内积，为1。

    ![image-20210506173901673](计算机网络-韩立刚.assets/image-20210506173901673.png)

  - 自己和自己的反码序列-A 格式化内积，为-1 。

    ![image-20210506173912505](计算机网络-韩立刚.assets/image-20210506173912505.png)



## 2.6 宽带接入技术

铜线接入 18:08 

光纤同轴混合网 光纤接入和移动互联网接 10:17 

### 2.6.1  铜线接入技术 （电话线接入Internet） 

- 铜线宽带接入技术也就是xDSL （各种类型DSL （Digital Subscriber Line） ）数字用户线路的总称）技术，就是用数字技术对现有的模拟电话用户线进行改造，使它能够承载宽带业务。

- ADSL 属于DSL 技术的一种，全称Asymmetric Digital Subscriber Line （非对称数字用户线路），亦可称作非对称数字用户环路。是用数字技术对现有的模拟电话用户线进行改造，使其能够承载带宽数字业务。ADSL 考虑了用户访问Internet 的主要是获取网络资源，更多的下载流量，较少的上行流量，因此ADSL 上行和下行带宽设计成为不对称。上行指到 从用户到 ISP ，而下行指从ISP  到用户。

- 电话线中的频繁服用--ADSL 信道

  ![image-20210506173959614](计算机网络-韩立刚.assets/image-20210506173959614.png)

- 基于ADSL 的接入网的组成

  ![image-20210506174026809](计算机网络-韩立刚.assets/image-20210506174026809.png)

  

### 2.6.2  光纤同轴混合网（HFC 网） （有线电视同轴电缆）

-   光纤同轴混合网（HFC 网）在1988 年被提出，HFC 是Hybrid Fiber Coax 的缩写。HFC 是在目前覆盖面很广的有线电视网CATV 的基础上开发的一种居民宽带接入网。HFC 网除可传送CATV 外还提供电话、数据和其他宽带交互型业务。

  ![image-20210506174103661](计算机网络-韩立刚.assets/image-20210506174103661.png)

  

### 2.6.3  光纤接入技术 （专门为小区居民铺设光缆）

- 从技术上讲，光纤到户FTTH （Fiber To The Home ）应当是最好的选择。所谓光纤到户，就是把光纤一直铺设到用户家庭，在用户的家中才把光信号转换成电信号，这样用户可以得到更高的上网速率。
- 根据光纤到用户的距离来分类，可分 成光 纤到小区（Fiber To The Zone 即 即FTTZ ）、光纤到路边（Fiber To The Curb 即FTTC ）、光纤到大楼（Fiber To The Building 即FTTB ）、光纤到户（Fiber To The Home即 FTTH ）以及光纤到桌面（Fiber To The Desk 即FTTD ）等。

### 2.6.4  移动互联网接入技术 （手机）

- 移动互联网，就是将 移动通信 和 互联网 二者结合起来，成为一体。

- 4G 全IP 网络

  ![image-20210506174219030](计算机网络-韩立刚.assets/image-20210506174219030.png)

- 基于子网的4G IP 网络

  ![image-20210506174257757](计算机网络-韩立刚.assets/image-20210506174257757.png)

  





# 第3章 GNS3和VMWare虚拟机搭建学习环境

2小时31分钟12节

- GNS3 是一款具有图形化界面、可以运行在多平台（包括Windows 、Linux 和Mac OS 等）上的网络虚拟软件。Cisco 网络设备管理员或是想要通过CCNA 、CCNP 、CCIE 等Cisco 认证考试的相关人士可以通过它来完成相关的实验；同时它也可以用于虚拟体验Cisco 网际操作系统IOS 或者检验将要在真实的路由器上部署实施的相关配置。
- 当然GNS3 对于我们学习计算机网络原理的学生，也是必不可少的工具。下面就讲解如何安装和配置GNS3 ，以及安装Wireshark抓包工具。

## 3-1 本章的地位 05:40 

1. 思科路由操作系统

   ![image-20210503224651126](计算机网络-韩立刚.assets/image-20210503224651126.png)

2. 下载GNS3最新版，默认安装，自带**抓包工具**

3. **主要组件说明：**

   - WinPCAP ：抓包必需组件之一，建议安装，如果已经安装过可忽略；
   - Wireshark ：最流行的开源抓包工具，需在线下载，建议安装，也可自行安装；
   - SolarWinds Response Time Viewer for Wireshark ：一个Wireshark 的辅助分析工具，需在线下载，文件大耗时较长，新手不建议安装；
   - Dynamips ：一个用于模拟思科路由器的工具，必须安装；
   - QEMU ：是一套由Fabrice Bellard 所编写的模拟处理器的自由软件，必须安装；
   - VPCS ：GNS3 中模拟客户端的工具，必须安装；
   - Cpulimt ：一款限制CPU 进程的工具软件，优化系统资源的占用率，可选安装；
   - GNS3 ：核心组件，必须安装；
   - SuperPutty ：GNS3 自带终端工具，可选安装。

   

## 3-2 安装抓包工具分析数据包 12:16 

![image-20210503230411840](计算机网络-韩立刚.assets/image-20210503230411840.png)



## 3-3 定义和使用抓包筛选器 16:01 

![image-20210503230642145](计算机网络-韩立刚.assets/image-20210503230642145.png)

跟换协议过滤器点右上角箭头生效



## 3-4 安装和配置GNS3 12:45 

1. www.gns3.com

2. 最新版，默认安装

3. 新建项目

4. 安装路由器

   ![image-20210503231019072](计算机网络-韩立刚.assets/image-20210503231019072.png)

   ![image-20210506180410845](计算机网络-韩立刚.assets/image-20210506180410845.png)

   

5. 非模块化路由器与模块化路由器

   1. 非模块化路由器 Cisco 2500

      ![image-20210503231111892](计算机网络-韩立刚.assets/image-20210503231111892.png)

      ![image-20210503231203368](计算机网络-韩立刚.assets/image-20210503231203368.png)

      

   2. 模块化路由器

      ![image-20210503231220166](计算机网络-韩立刚.assets/image-20210503231220166.png)

6. 配置模块

   ![image-20210503231322037](计算机网络-韩立刚.assets/image-20210503231322037.png)

   1. NM-16ESW 16 个Fastethernet 接口（交换模块，在使用此模块做交换实验时，请
      使用no ip routing 关闭端口路由）
   2. NM-1E 1 个Ethernet 接口
   3. NM-1FE-TX 1 个Fastethernet 接口
   4. NM-4E 4 个Ethernet 接口
   5. NM-4T 4 个serial 接口





## 3-5 配置路由器和VPCS 24:09 

### pc配置命令和思科路由器命令

```sh
PC
pc>ip192.168.10.2255.255.250192.168.10.10
PC1> show

配置路由器以太网接口地址
R1#configure terminal
RI（config）#interface fastEthernet 0/0
R1（ config-if）# ip address192.168.10.1025255.250
R1（config-if）#no shutdown
RI（config-if）#exit
RI（config）#exit
R1#

配置广域网接口的命令
R1#show controllers serial 2/0
R1（config）#interface s
R1（config）#interface serial 2/0
RI（config-if）#clock rate
R1（config-if）#clock rate 64000
R1（ config-if）# ip address192.168.20.10255.25.255.0
RI（config-if）#no shutdown
R1#copy running-config startup-config
R1#show running-config

RI#show ip route
R1(config)# ip route 192.168.80.0 255.255.255.0 192.168.20.20

配置路由器以太网接口地址
◼Router>enable -- 进入特权模式
◼Router#config terminal -- 进入全局配置模式
◼Router(config)#interface fastEthernet 0/0 -- 进入接口配置模式
◼Router(config-if)#ip address 192.168.10.10 255.255.255.0 -- 添加IP地址
和子网掩码
◼Router(config-if)#no shutdown --

查看接口是DTE还是DCE
◼ Router(config-if)#exit -- 退出接口配置模式
◼ Router(config)#exit -- 退出全局配置模式
◼ Router#show controller serial 1/0 -- 查看接口是DCE 还是DTE
◼ M4T: show controller:
◼ PAS unit 0, subunit 0, f/w version 1-45, rev ID 0x2800001, version1
◼ idb = 0x643AE70C, ds = 0x643AF7D4, ssb=0x643AFB90
◼ Clock mux=0x0, ucmd_ctrl=0x1C, port_status=0x7B
◼ Serial config=0x8, line config=0x200
◼ maxdgram=1608, bufpool=78Kb, 120 particles
◼ DCD=up DSR=up DTR=up RTS=up CTS=up
◼ line state: up
◼ cable type : V.11 (X.21) DCE cable, received clockrate 64000 -- 可以看到该接口为DCE 需要配置时钟

配置Serial接口时钟频率和IP地址
◼Router#config terminal
◼Router(config)#interface serial 1/0 -- 进入接口配置模式
◼Router(config-if)#clock rate 64000 -- 配置时钟频率，控制带宽
◼Router(config-if)#encapsulation ppp -- 配置帧封装格式为ppp
◼Router(config-if)#ip address 172.16.0.1 255.255.255.0
◼Router(config-if)#no shutdown
◼Router(config-if)#exit
◼Router(config)#exit
◼Router#copy running-config startup-config -- 保存配置
```



## 3-6 将配置好的环境保存成快照 10:37 

![image-20210503231935354](计算机网络-韩立刚.assets/image-20210503231935354.png)



## 3-7 使用Wireshark捕获GNS3搭建的网络环境中的 06:26 

![image-20210503232032819](计算机网络-韩立刚.assets/image-20210503232032819.png)

![image-20210503232048016](计算机网络-韩立刚.assets/image-20210503232048016.png)

项目名不要用中文，会无法运行抓包工具

- 可以抓多种传输协议

![image-20210503232149537](计算机网络-韩立刚.assets/image-20210503232149537.png)



## 3-8 详细讲解VMWareWorkstation在你的计算 21:57 

![image-20210503232328030](计算机网络-韩立刚.assets/image-20210503232328030.png)

- 桥接模式
  - 和电脑共用网卡，
  - 相当于直接连接外部路由器
- 仅主机
  - 物理机通过虚拟网卡与虚拟机相连
- NAT 模式
  - 共享主机 ip 地址

```
win环境：
运行,
wf.msc,
快速打开防火墙设置
```



## 3-9 GNS3路由器连接VMWare虚拟机 18:44 

- 连接形式

![image-20210503233239131](计算机网络-韩立刚.assets/image-20210503233239131.png)

- 主机设置

  ![image-20210503233352321](计算机网络-韩立刚.assets/image-20210503233352321.png)

- 新版使用云替代主机

  ![image-20210503233450134](计算机网络-韩立刚.assets/image-20210503233450134.png)

- 虚拟机ip地址设置

  ![image-20210503233543930](计算机网络-韩立刚.assets/image-20210503233543930.png)

- 路由转发表设置及命令

  `show ip route`

  `ip route 目的ip域 掩码 跳板ip地址 `

  ![image-20210503233735179](计算机网络-韩立刚.assets/image-20210503233735179.png)

- 跟踪路由

  `tracert ip`

  ![image-20210503234041144](计算机网络-韩立刚.assets/image-20210503234041144.png)

  



## 3-10 思科Packet Tracer 03:20 

- CCNA 学习考试用，不是真实路由器
- https://www.netacad.com/portal/node/488
  - 注册账号，加入课程可下载
  - 安装汉化





## 3-11 Cisco PacketTracer 模拟软件搭建实验环境 15:45 

![image-20210503234438019](计算机网络-韩立刚.assets/image-20210503234438019.png)



## 3-12 使用PacketTracer跟踪数据包 04:08 

![image-20210503234525415](计算机网络-韩立刚.assets/image-20210503234525415.png)



# 第4章 数据链路层

5小时3分钟26节

4-1 本章主要内容 13:08 

4-2 数据链路层功能-封装成帧 17:49 

4-3 数据链路层功能-透明传输 10:32 

4-4 数据链路层功能-差错检验 11:43 

4-5 点到点信道数据链路层 10:56 

4-6 配置路由器广域网接口使用PPP协议封装 07:32 

4-7 PPP协议帧格式 07:36 

4-8 同步传输和异步传输 11:37 

4-9 PPP协议透明传输填充方式 06:06 

4-10 广播信道的数据链路层-CSMA/CD协议 19:23 

4-11 计算以太网最短帧 11:50 

4-12 冲突解决方法-退避算法 14:35 

4-13 以太网帧格式 11:37 

4-14 以太网道利用率 06:18 

4-15 网卡的作用-工作在数据链路层和物理层 09:08 

4-16 查看 更改网卡的MAC地址 跨网段扫描MAC地址 28:56 

4-17 扩展以太网规模和距离 07:31 

4-18 使用网桥和交换机优化以太网 08:01 

4-19 网桥MAC地址表构建过程 08:34 

4-20 实战：查看交换机MAC地址表 06:31 

4-21 交换机组网优缺点 13:59 

4-22 生成树协议 17:03 

4-23 配置生成树协议查看接口状态 10:05 

4-24 实战：查看生成树 关闭生成树 观察广播风暴 12:11 

4-25 快速以太网-100M以太网 06:21 

4-26 千兆万兆以太网 14:29 

**本章重点：讲解帧在不同链路的封装。**
![image-20210506223223753](计算机网络-韩立刚.assets/image-20210506223223753.png)

## 4.1 数据链路层的三个基本问题

### 4.1.1  数据链路和帧

- **数据链路 和数据链路的区别**

  - **链路（Link ）**是指的从一个节点到相邻节点的一段物理线路（有线或无线），而中间没有任何其他的交换节点。
  - **数据链路（Data Link ）**则是另一个概念，这是因为当需要在一条线路上传送数据时，除了必须有一条物理线路外，还必须有一些必要的通信协议来控制这些数据的传输。

  ![image-20210506223417943](计算机网络-韩立刚.assets/image-20210506223417943.png)

- 数据链路层把网络层交下来的数据封装成**帧**发送到链路上，以及把接收到的帧中的数据取出并上交给网络层。

  在因特网中，网络层协议数据单元就是 **IP数据报**（或简称为数据报、分组或包）。数据链路层封装的**帧**，在物理层变成数字信号在链路上传输。

![image-20210506223532183](计算机网络-韩立刚.assets/image-20210506223532183.png)

- 本章探讨数据链路层，就不考虑物理层如何实现比特传输的细节，我们就可以简单的认为数据帧通过数据链路由节点A发送到节点B。

![image-20210506223604931](计算机网络-韩立刚.assets/image-20210506223604931.png)



### 4.1.2  数据链路层三个基本问题

1. **封装成帧**

   - 封装成帧，就是在将**网络层的IP 数据报**的前后分别添加首部和尾部，这样就构成了一个帧。
   - 不同的数据链路层协议的帧的首部和尾部包含的信息有明确的规定，**帧的首部和尾部有帧开始符和帧结束符，称为帧定界符**。接收端收到物理层传过来的数字信号读取到帧开始字符一直到帧结束字符，就认为接收到了一个完整的帧。
   - 在数据传输中出现差错时，**帧定界符**的作用更加明显。
   - 每一种数据链路层协议都规定了所能够传送的帧的数据部分长度的上限--即最大传输单元**MTU （Maximum Transfer Unit ）**，以太网的 MTU 为 **1500 个字节** 。

   ![image-20210506223831494](计算机网络-韩立刚.assets/image-20210506223831494.png)

   

2. **透明传输**

   - 帧开始符和帧结束符最好是不会出现在帧的数据部分的字符，通常我们电脑键盘能够输入的字符是ASCII 字符代码表中打印字符，在ASCII 字符代码表中，还有非打印控制字符，在非打印字符中有两个字符专门用来做帧定界符，代码**SOH （Start Of Header ）**作为**帧开始定界符**，对应的二进制编码为00000001 ，代码**EOT （End Of Transmission ）**作为**帧结束定界符** 。

   ![image-20210506223948413](计算机网络-韩立刚.assets/image-20210506223948413.png)

   - 当数据部分是非ASCII 字符代码表的文本文件时（比如二进制代码的计算机程序或图像等），情况就不同了。如果数据中的某一段二进制代码正好和SOH 或EOT 帧定界符编码一样，接收端就会误认为这就是帧的边界。
   - 现在就要想办法让接收端能够区分帧中EOT 或SOH 是数据部分还是帧定界符，我们可以在数据部分出现的帧定界符编码前面插入转义字符，
   - 如果传输的数据中，出现了帧开始字符和真结束字符，要添加转义字符，告诉接收端后面是数据。
     - **接收端收到后去掉转义字符，收到发送数据，这就是透明传输**。
     - 不同的数据链路层协议，定义的转义字符不一样。

   ![image-20210506224048845](计算机网络-韩立刚.assets/image-20210506224048845.png)

   1. ASCII 字符集中“头标开始”和“传输结束”是非打印控制字符。

   2. 避免在用户使用键盘输入帧开始字符和帧结束字符。

      ![image-20210506224335676](计算机网络-韩立刚.assets/image-20210506224335676.png)

3. **差错检验**

   - 现实的通信链路都不会是理想的。这就是说，比特在传输过程中可能会产生差错：1 可能会
     变成0 ，而0 也可能变成1 ，这就叫做**比特差错**。

   - 为了保证数据传输的可靠性，在计算机网络传输数据时，必须采用各种差错检测措施。目
     前在数据链路层广泛使用了**循环冗余检验CRC（Cyclic Redundancy Check ）**的差错检验技术。

   - 要想让接收端能够判断帧在传输传输过程是否出现差错，需要在传输的帧中包含用于检测
     错误的信息，这部分信息就称为**帧校验序列FCS （Frame Check Sequence）**

   ![image-20210506224110461](计算机网络-韩立刚.assets/image-20210506224110461.png)

   1. **CRC运算示例**

      - 首先在要校验的二进制数据M=101001 后面添加n 位0 ，再除以收发双方事先商定好的n+1 位的除数P ，得出的商是Q ，而余数是R （n 位，比除数少一位），这个n 位余数R 就是计算出的FCS。 
      - 假如要得到3 位帧校验序列，就要在M 后面添加3 个0 ，就成为101001000 ，假定事先商定好的除数P=1101 （4 位），如图4-10 所示，做完除法运算后余数是001 ，001 将会添加到帧的尾部作为帧校验序列FCS ，得到商Q=110101 ，这个商并没什么用途。
      - 可以整除即正确。
      
      ![image-20210506224154358](计算机网络-韩立刚.assets/image-20210506224154358.png)



## 4.2 点到点信道的数据链路

- 点到点信道是指的一条链路上就一个发送端和接收端的信道，通常用在广域网链路。

  ![image-20210506224646645](计算机网络-韩立刚.assets/image-20210506224646645.png)

### 4.2.1 PPP协议的特点

1. **简单**  不提供可靠传输
2. **封装成帧** 首部和尾部 帧开始符  帧结束符
3. **透明传输** 加转义字符  收到后去掉转移字符
4. **差错检测** CRC 计算FCS
5. **支持多种网络层协议** IPv4 和IPv6 网络层协议都可以封装到PPP 帧中
6. **多种类型链路**    光纤 铜线 同步传输  异步传输  串行、并行链路均可
7. **检测连接状态**  检测连接状态
8. **最大传送单元**  最大传输单元 1500 字节
9. **网络层地址协商**  能够为拨号的一段分配IP 地址，子网掩码  网关和DNS
10. **数据压缩协商**

### 4.2.2 PPP协议的组成

- PPP 协议有三个组成部分：

  ![image-20210508150451551](计算机网络-韩立刚.assets/image-20210508150451551.png)

### 4.2.3 同步传输和异步传输

- 同步传输

  - **同步传输（Synchronous Transmission ）**以数据帧为单位传输数据，可采用字符形式或位组合形式的帧同步信号，在短距离的高速传输中，该时钟信号可由专门的时钟线路传输，由发送端或接收端提供专用于同步的时钟信号。计算机网络采用同步传输方式时，常将时钟同步信号（前同步码）植入数据信号帧中，以实现接收端与发送端的时钟同步。

  ![image-20210506224949477](计算机网络-韩立刚.assets/image-20210506224949477.png)

- 异步传输

  - **异步传输（Asynchronous Transmission ）**以字符为单位传输数据，发送端和接收端具有相互独立的时钟（频率相差不能太多），并且两者中任一方都不向对方提供时钟同步信号。

  ![image-20210506225026116](计算机网络-韩立刚.assets/image-20210506225026116.png)

### 4.2.4抓包查看PPP的帧首部

1. **查看路由器协议**

   ![image-20210508145858330](计算机网络-韩立刚.assets/image-20210508145858330.png)

   - 物理接口up，数据链路up，HDLC协议

   ![image-20210508150045330](计算机网络-韩立刚.assets/image-20210508150045330.png)

   

2. **PPP 首部三个字段**

   1. Address 是地址字段
   2. Control 是控制字段
   3. Protocol 是协议字段

   ![image-20210506225123782](计算机网络-韩立刚.assets/image-20210506225123782.png)

### 4.2.5 PPP协议帧格式

- **Address** 字段的值为**0xff** ，0x 表示后面的ff 为十六进制数，写成二进制为1111 1111， 占一个字节的长度。点到点信道PPP 帧中的地址字段形同虚设，可以看到没有源地址和目标地址。
- **Control** 字段的值为**0x03** ，写成二进制为0000 0011 ，占一个字节长度。最初曾考虑以后对地址字段和控制字段的值进行其他定义，但至今也没给出。
- **Protocol** 字段占**2个字节**，不同的值用来标识PPP 帧内信息是什么数据。

![image-20210506225212083](计算机网络-韩立刚.assets/image-20210506225212083.png)

### 4.2.6 PPP帧填充方式

- **异步传输使用字节填充**

  - 在异步传输的链路上，数据传输以字节为单位，PPP 帧的转义符定义为0x7D， 并使用字节填充 。
  - 把信息字段中出现的每一个0x7E 字节转变成为2 字节序列（0x7D ，0x5E ）。
  - 若信息字段中出现一个0x7D 的字节（即出现了和转义字符一样的比特组合），则把0x7D 转变成为2 字节序列（0x7D ，0x5D） 。

  ![image-20210506225341439](计算机网络-韩立刚.assets/image-20210506225341439.png)

- **同步传输使用零比特填充**

  - 在同步传输的链路上，数据传输以帧为单位，PPP 协议采用零比特填充方法来实现透明传输。大家把PPP 协议帧界定符0x7E 写成二进制01111110, 也就是可以看到中间有连续的6 个1，  只要想办法在数据部分不要出现连续的6 个1,就肯定不会出现这界定符。具体办法就是“零比特填充法”。

  ![image-20210506225415644](计算机网络-韩立刚.assets/image-20210506225415644.png)

  



## 4.3 广播信道的数据链路

### 4.3.1  广播信道的局域网

- 最初的局域网使用同轴电缆进行组网，总线型拓扑 。

- 广播信道使用 带冲突检测的载波侦听多路访问（ CSMA/CD  ）机制通信。 。CSMA/CD 就是广播信道使用的数据链路层协议，**使用CSMA/CD 协议的网络就是以太网**。

- 点到点链路就不用冲突检测，因此没必要使用CSMA/CD 协议。

  ![image-20210507025958977](计算机网络-韩立刚.assets/image-20210507025958977.png)

- 使用集线器组建的局域网也是广播信道 ， 是 总线型拓扑 。

  ![image-20210507030047940](计算机网络-韩立刚.assets/image-20210507030047940.png)

  

### 4.3.2  以太网标准

- **以太网（Ethernet ）**是一种计算机局域网组网技术。IEEE 制定的IEEE 802.3 标准给出了以太网的技术标准，即以太网的介质访问**控制协议（CSMA/CD ）**及**物理层技术规范**（包括物理层的连线、电信号和介质访问层协议的内容）。

- 在 在IEEE 802.3 标准中 ， 为不同的传输介质制定了不同的物理层标准，在这些标准中前面的数字表示传输速度，单位是“Mbps ”，最后的一个数字表示单段网线长度（基准单位是100m ），Base 表示“基带”的意思。

  ![image-20210507030120649](计算机网络-韩立刚.assets/image-20210507030120649.png)

  

### 4.3.3 CSMA/CD 协议

- 总线型网络使用CSMA/CD 协议进行通信，即带冲突检测的载波侦听多点接入技术。

- 即便检测出总线上没有信号，开始发送数据后也有可能和迎面而来的信号在链路上发生碰撞。

  - 比如，A 计算机发送的信号和B 计算机发送的信号在链路C 处发生碰撞，碰撞后的信号相互叠加，在总线上电压变化幅度将会增加，发送方检测到电压变化超过一定的门限值时，就认为发生冲突，这就是冲突检测。

- 使用CSMA/CD 协议的以太网不可能进行全双工通信而只能进行双向交替通信（半双工通信）。

  ![image-20210507030321451](计算机网络-韩立刚.assets/image-20210507030321451.png)

  

### 4.3.4  以太网最短帧

- 为了能够检测到正在发送的帧在总线上是否产生冲突，以太网的帧不能太短，如果**太短就有可能检测不到自己发送的帧产生了冲突**。下面咱们探讨以太网的帧最短应该是多少字节。

  ![image-20210507030346763](计算机网络-韩立刚.assets/image-20210507030346763.png)

- 下图因为帧太短不能检测到自己发的帧是否发生了冲突

  ![image-20210507030408497](计算机网络-韩立刚.assets/image-20210507030408497.png)

- 以太网设计最大端到端长度为5km （实际上的以太网覆盖范围远远没有这么大），单程传播时延为大约为25.6μs, 往返传播时延为51.2μs ，**10M 标准以太网最小帧为**：

  ![image-20210507030514046](计算机网络-韩立刚.assets/image-20210507030514046.png)

- 512 比特也就是**64 字节**，这就意味着以太网发送数据帧如果前64字节没有检测出冲突，后面发送的数据就一定不会发生冲突。换句话说，如果发生碰撞，就一定在发送前64 字节之内。由于一旦检测出冲突就立即终止发送，这时发送的数据一定小于64 字节，因此凡是长度小于64 字节的帧都是由于冲突而异常终止的无效帧，只要收到了这种无效帧，就应当立即将其终止。

  

### 4.3.5  冲突解决方法-- 退避算法

- 总线型网络中的计算机数量越多，在链路上发送数据产生冲突机会就多。

  ![image-20210507030558049](计算机网络-韩立刚.assets/image-20210507030558049.png)

- 计算机要想知道发送的帧在链路上是否发生碰撞必须等待 $2\tau$ 往返时间， $2\tau$ 称为争用期。

- 以太网使用**截断二进制指数退避（truncated binary exponential backoff ）算法**来解决碰撞问题。

  1. 确定基本退避时间，它就是争用期2τ 。以太网把争用期定为51.2μs 。对于10Mb/s以太网，在争用期内可发送512bit ，即64 字节。也可以说争用期是512 比特时间。1比特时间就是发送1比特所需的时间。所以这种时间单位与数据率密切相关。

  2. 从离散的整数集合$［0 ，1 ，… ，（2 ^k -1 )］$中随机取出一个数，记为 r 。重传应推后的时间就是 **r 倍的争用期**。上面的参数k 按下面的公式计算：

     $k=Min[ 重传次数，10]$

     可见当重传次数不超过10 时，参数k 等于重传次数；但当重传次数超过10 时，k 就不再增大而一直等于10。

  3. 当重传达16 次仍不能成功时（这表明同时打算发送数据的站太多，以致连续发生冲突），则丢弃该帧，并向高层报告。

### 4.3.6  以太网帧格式

- 常用的以太网MAC 帧格式有两种标准，一种是**EthernetV2 标准**（即以太网V2标 标准），另一种是IEEE 的802.3 标准。使用得最多的是以太网V2 的MAC帧格式。

  ![image-20210507030902192](计算机网络-韩立刚.assets/image-20210507030902192.png)

  

- **Ethernet II 的帧**比较简单，由五个字段组成。

  1. 前两个字段分别为**6 字节**长的**目的MAC 地址**和**源MAC 地址**字段。
  2. 第三个字段是**2 字节**的**类型字段**，用来标志上一层使用的是什么协议，以便把收到的MAC帧 帧的数据上交给上一层的这个协议。第四个字段是数据字段，其长度在46 到1500 字节之间 。
  3. 最后一个字段是**4 字节**的**帧检验序列FCS** （使用CRC 检验）

  ![image-20210507031020466](计算机网络-韩立刚.assets/image-20210507031020466.png)

  

- 当数据字段的长度小于46 字节时，数据链路层就会在数据字段的后面加入一个整数字节的填充字段，以保证以太网的MAC 帧长不小于64 字节，接收端还必须能够将添加的字节去掉。

  ![image-20210507031044095](计算机网络-韩立刚.assets/image-20210507031044095.png)

  

- **IEEE802.3 标准规定凡出现下列情况之一的即为无效的MAC 帧：**

  - 帧的长度不是整数个字节。
  - 用收到的帧检验序列FCS 查出有差错。
  - 收到的帧的MAC 客户数据字段的长度不在46-1500 字节之间。考虑到 到MAC 帧首部和尾部的长度共有18 字节，可以得出有效的MAC 帧长度为64-1518 字节之间。

- 对于检查出的无效MAC 帧就简单地丢弃。以太网不负责重传丢弃的帧。

  

### 4.3.7  以太网信道利用率

- 利用率是指的发送数据的时间占整个时间的比例。如图所示 ， 平均发送一帧所需要的时间，经历了n 倍争用期2τ， T 0 为发送该帧所需时间，τ 为该帧传播时延。]

  ![image-20210508180545149](计算机网络-韩立刚.assets/image-20210508180545149.png)
  $$
  有冲突时信道利用率：S=\frac{T_0}{n2\tau+T_0+\tau}
  $$
  

- 从公式可以看出，要想提高信道利用率最好是n 为0 ，这就意味着以太网上的各个计算机发送数据不会产生碰撞（这显然已经不是CSMA/CD ，而需要一种特殊的调度方法），并且能够非常有效的利用网络的传输资源，即总线一旦空闲就有一个站立即发送数据。这种情况算出来的信道利用率是极限信道利用率。

  ![image-20210507031308766](计算机网络-韩立刚.assets/image-20210507031308766.png)

- 要想提高极限信道利用率就要降低公式中 的$\displaystyle \frac{\tau }{t_0}$ 比值

- τ 值和以太网连线的长度有关，这就意味着τ 值要小，  以太网**网线的长度就不能太长**。带宽一定的情况下T0 和帧的长度有关，这就意味着，**以太网的帧不能太短**。

  

### 4.3.8  网卡的作用

- **网卡**是工作在**链路层和物理层**的网络组件，是局域网中连接计算机和传输介质的接口，不仅能实现与局域网传输介质之间的物理连接和电信号匹配，还涉及帧的发送与接收、帧的封装与拆封、帧的差错校验、介质访问控制（以太网使用CSMA/CD 协议）、数据的编码与解码以及数据缓存的功能等。

  ![image-20210507031624633](计算机网络-韩立刚.assets/image-20210507031624633.png)

  

### 4.3.9 MAC 地址

- 在广播信道实现点到点通信，这就需要网络中的每个网卡有一个地址。这个地址称为物理地址或MAC 地址（因为这种地址用在**MAC 帧**中）。IEEE802 标准为局域网规定了一种 **48 位的全球地址** 。

- 这种**6 字节**的MAC 地址已被固化在网卡的ROM 中。因此，MAC 地址也叫作**硬件地址（hardware address ）**或物理地址。当这块网卡插入（或嵌入）到某台计算机后，网卡上的MAC 地址就成为这台计算机的MAC地址了。

  ![image-20210507031705464](计算机网络-韩立刚.assets/image-20210507031705464.png)

- 网卡有 **过滤功能**，适配器从网络上每收到一个MAC 帧就先用硬件检查MAC 帧中的目的地址。如果是发往本站的帧则收下，然后再进行其他的处理。否则就将此帧丢弃，不再进行其他的处理。这样做就不浪费主机的处理机和内存资源。这里“发往本站的帧”包括以下三种帧：

  1. **单播（unicast ）**帧（一对一），即收到的帧的MAC 地址与本站的硬件地址相同。
  2. **广播（broadcast ）**帧（一对全体），即发送给本局域网上所有站点的帧（全1 地址）。
  3. **多播（multicast ）**帧（一对多），即发送给本局域网上一部分站点的帧。

  

### 4.3.10  实战：查看和更改MAC 地址

![image-20210507031940656](计算机网络-韩立刚.assets/image-20210507031940656.png)

![image-20210507031947924](计算机网络-韩立刚.assets/image-20210507031947924.png)

- **mac 地址扫描**

  ![image-20210508205407889](计算机网络-韩立刚.assets/image-20210508205407889.png)



## 4.4 扩展以太网

### 4.4.1 集线器

- 传统以太网最初是使用粗同轴电缆，后来演进到使用比较便宜的细同轴电缆，最后发展为使用更便宜和更灵活的双绞线。

- 1990 年IEEE 制定出星形以太网10BASE-T 的标准802.3i 。“10 ”代表10Mb/s 的数据率，BASE 表示连接线上的信号是基带信号，T 代表双绞线。

- 10BASE-T 以太网的通信距离稍短，每个站到集线器的距离不超过100m。 。

- 集线器和网线一样工作在物理层 。

  ![image-20210507032050791](计算机网络-韩立刚.assets/image-20210507032050791.png)

  

### 4.4.2 计算机数量和距离上扩展

- 独立的冲突域

  ![image-20210507032149707](计算机网络-韩立刚.assets/image-20210507032149707.png)

  

- 可以将多个集线器连接在一起形成一个更大的以太网，这不仅可以扩以太网中计算机的数量，还可以扩展以太网的覆盖范围。使用主干集线器连接教室中集线器，形成一个大的以太网，计算机之间的最大距离可以达到400米。

  ![image-20210507032204153](计算机网络-韩立刚.assets/image-20210507032204153.png)

  

- 要是两个集线器的距离超过100 米，还可以光纤从将两个集线器连接起来，集线器之间通过光纤连接，可以将相距几千米的集线器连接起来，需要通过光电转换器，实现光信号和电信号的相互转换。

  ![image-20210507032232075](计算机网络-韩立刚.assets/image-20210507032232075.png)

  

### 4.4.3 使用网桥优化以太网

- **利用网桥优化以太网**

  ![image-20210507032326350](计算机网络-韩立刚.assets/image-20210507032326350.png)

  

- **网桥特点**

  1. 网桥基于MAC地址转发帧，工作在数据链路层。
  2. —个接囗—个冲突域。冲突域数量增加，冲突减少。
  3. 实现帧的存储转发，增加了时延。
  4. E1接口和E2接口可以是不同的带宽。

  

### 4.4.4 网桥自动构建MAC 地址表

- 使用网桥优化以太网，对于网络中的计算机是没有感觉的，也就是以太网中的计算机是不知道网络中有网桥存在，也不需要网络管理员配置网桥的MAC 地址表，因此我们称网桥是透明桥接。

- 网桥接入以太网时，MAC 地址表示空的，网桥会在计算机通信过程中自动构建MAC 地址表，这称为“自学习”。

  1. 自学习
     - 网桥的接口收到一个帧，就要检查MAC 地址表中与收到的帧源MAC 地址有无匹配的项目，如果没有，就在MAC 地表中添加该接口和该帧的源MAC 地址对应关系以及进入接口的时间，如果有，则把原有的项目进行更新。
  2. 转发帧
     - 网桥接口收到一个帧，就检查MAC 地址表中有没有该帧目标MAC 地址对应端口，如果有，就会将该帧转发到对应的端口，如果没有，则将该帧转发到全部端口（接收端口除外）。

  ![image-20210507032720959](计算机网络-韩立刚.assets/image-20210507032720959.png)

  

### 4.4.5 多接口网桥-- 交换机

![image-20210507032800886](计算机网络-韩立刚.assets/image-20210507032800886.png)

- 使用交换机组网与集线器组网相比有以下特点 ：

  1. **独享带宽**

     - 交换机的每个端口独享带宽，10M 交换机，则每个端口带宽是10M ，24 口10M 交换机，交换机的总体交换能力是240M ，这和集线器不同。

  2. **安全**

     - 使用交换机组建的网络比集线器安全，比如计算机A 给计算机B 发送的帧，以及计算机D 给计算机C 发送的帧，交换机根据MAC 地址表只转发到目标端口，E 计算机根本收不到其他计算机的通信的数字信号，即便安装了抓包工具也没用。

  3. **全双工通信**

     - 交换机接口和计算机直接相连，计算机和交换机之间的链路可以使用全双工通信。

  4. **全双工不再使用CSMA/CD 协议**

     - 用 交换机接口和计算机直接相连接，使用全双工通信数据链路层就不需要使用CSMA/CD 协议，但我们还是称交换机组建的网络是以太网，是因为帧格式和以太网一样。

  5. **接口可以工作在不同的速率**

     

- **转发广播帧到所有端口**

  ![image-20210507032952944](计算机网络-韩立刚.assets/image-20210507032952944.png)

- 集线器是冲突域

- 交换机是广播域

- 路由器隔绝广播

![image-20210507033208321](计算机网络-韩立刚.assets/image-20210507033208321.png)





### 4.4.6 实战：查看交换机MAC 地址表

- 交换机能够学习根据帧的源MAC 地址构造MAC 地址表

  ![image-20210507033235901](计算机网络-韩立刚.assets/image-20210507033235901.png)

  

4.4.7 实战：验证交换机端口安全

4.4.8 实战：验证集线器不安全

### 4.4.8 生成树协议

- 存在单点故障

  ![image-20210508221835910](计算机网络-韩立刚.assets/image-20210508221835910.png)

- 双汇聚层

  - 有环路
  - 形成广播风暴

  ![image-20210508221922785](计算机网络-韩立刚.assets/image-20210508221922785.png)

- **生成树协议**

  1. 选根交换机网桥ID = 优先级+MAC地址 值越小 优先级越高
  2. 其他的交换机 选根端口 距离根交换机近 端口 根端口
  3. 每根网线 哪头距离根交换机更近 指定端口
     指定端口和根端口 转发状态 
  4. 其他端口 阻断状态

![image-20210508223117072](计算机网络-韩立刚.assets/image-20210508223117072.png)

- 查看生成树

  `show spanning-tree vlan 1`

  ![image-20210508224727415](计算机网络-韩立刚.assets/image-20210508224727415.png)

  ![image-20210508230504776](计算机网络-韩立刚.assets/image-20210508230504776.png)

  

- **修改生成树优先级**

  `spanning-tree vlan 1 priority 4096`

  ![image-20210508225046140](计算机网络-韩立刚.assets/image-20210508225046140.png)

  网桥ID越小，优先级越高

  ![image-20210508231143688](计算机网络-韩立刚.assets/image-20210508231143688.png)

  

- 关闭生成树

  `no spanning-tree vlan 1`

![image-20210508231337149](计算机网络-韩立刚.assets/image-20210508231337149.png)



## 4.5 高速以太网

### 4.5.1 100M 以太网

- 100BASE-T 是在双绞线上传送100Mb/s 基带信号的星型拓扑的以太网，仍使用IEEE802.3 的CSMA/CD 协议，它又称为快速以太网（FastEthernet ）。

- 使用交换机组建的100BASE-T 以太网，可在全双工方式下工作而无冲突发生。因此，CSMA/CD 协议对全双工方式工作的快速以太网是不起作用的 。因为其帧格式和以太网一样，所以依然称交换机组件的网络为以太网。

- 以太网的最短帧和带宽和链路长度有关，100M 以太网比10M 以太网速率提高10 倍，要想和10M 以太网兼容，就要确保最短帧也是64 字节，那就将电缆最大长度由1000m 降到100m ，因此以太网的争用期依然是5.12μs ，最短帧依然是64 字节。

  1. 快速以太网100M 带宽，有以下标准：

  ![image-20210507033404630](计算机网络-韩立刚.assets/image-20210507033404630.png)



### 4.5.2  吉比特以太网

- 吉比特以太网的标准IEEE802.3 z 有以下几个特点：

  1. 允许在1Gb/s 下全双工和半双工两种方式工作。
  2. 使用IEEE802.3 协议规定的帧格式。
  3. 在半双工方式下使用CSMA/CD 协议（全双工方式不需要使用CSMA/CD 协议）。
  4. 与10BASE-T 和100BASE-T 技术向后兼容。

- 吉比特以太网1000M 带宽，有以下标准：

  ![image-20210507033510679](计算机网络-韩立刚.assets/image-20210507033510679.png)

- 吉比特以太网工作在半双工时，就必须进行碰撞检测，数据速率提高了，要想和10M 以太网兼容，就要确保最短帧也是64 字节，这只能减少最大电缆长度，以太网最大电缆长度就要缩短到10m， 短到几乎没有什么实用价值 。 吉比特以太网为了增加最大传输距离，将最短帧增加到4096 比特 。

- 当数据帧长度小于**512 字节（即4096 比特）**时，在FCS 域后面添加“**载波延伸**”  域。主机发送完短数据帧之后，继续发送载波延伸信号，冲突信号传回来时，发送端就能感知到了。

  ![image-20210507033550750](计算机网络-韩立刚.assets/image-20210507033550750.png)

- 如果发送的数据帧都是64 字节的短报文，那么链路的利用率就很低，因为“载波延伸”域将占用大量的带宽。

- 千兆以太网标准中，引入了**“分组突发”（packet bursting ）**机制来改善这个问题。这就是当很多短帧要发送时，第一个短帧采用上面所说的载波延伸的方法进行填充，随后的一些短帧则可以一个接一个发送，它们之间只需要留有必要的帧间最小间隔即可 。

  ![image-20210507033643231](计算机网络-韩立刚.assets/image-20210507033643231.png)

  

### 4.5.3 10吉比特以太网

- 10GE 的帧格式与10Mb/s ，100Mb/s 和1Gb/S 以太网的帧格式完全相同。10GE 还保留了802.3 标准规定的以太网最小和最大帧长。
- 由于数据率很高，10GE 不再使用铜线而只使用光纤作为传输媒体。它使用长距离（40km ）的光收发器与单模光纤接口，以便能够工作在广域网和城域网的范围。
- 10GE 只工作在全双工模式，因此不存在争用问题，也不使用CSMA/CD 协议。这就使得10GE 的传输距离不再受碰撞检测的限制而大大提高了。
- 10GE 的物理层有以下标准：

![image-20210507033733836](计算机网络-韩立刚.assets/image-20210507033733836.png)



# 第5章 IP地址和子网划分

4小时11分钟22节

5-1 预备知识-二进制和十进制之间的关系 21:08 
5-2 预备知识-十六进制和二进制之间的转换 08:11 
5-3 MAC地址的作用和IP地址的作用 08:24 
5-4 IP地址格式 08:46 
5-5 子网掩码的作用 13:29 
5-6 IP地址的分类 14:35 
5-7 保留的特殊IP地址 12:29 
5-8 实战 验证主机位全1代表本网段所有主机 16:13 
5-9 公网IP地址和私网IP地址地址 12:32 
5-10 私网地址访问Internet需要进行端口地址转换(P 14:18 
5-11 为什么要划分子网 08:50 
5-12 等长子网划分 14:46 
5-13 等分成4个子网8个子网 18:19 
5-14 B类地址和A类地址子网划分 09:39 
5-15 变长子网划分 10:14 
5-16 点到点网络的子网掩码 04:54 
5-17 子网掩码的另外一种表示方法-CIDR 08:21 
5-18 判断一个IP地址所在的网段 07:07 
5-19 子网划分需要注意的几个问题 07:03 
5-20 使用超网合并网段 14:47 
5-21 合并网段的规律 10:28 
5-22 判断一个网段是超网还是子网 06:40 

## 5.1  学习IP 地址预备知识

### 5.1  学习IP 地址预备知识

### 5.1.1  二进制和十进制

- 二进制 		十进制
  ◼ 1 				  1
  ◼ 10 				2
  ◼ 100 			  4
  ◼ 1000 			8
  ◼ 1 0000		 16
  ◼ 10 0000	   32
  ◼ 100 0000 	64
  ◼1000 0000   128
- 二进制 	   十进制
  ◼1000 0000 128
  ◼1100 0000 192
  ◼1110 0000 224
  ◼1111 0000 240
  ◼1111 1000 248
  ◼1111 1100 252
  ◼1111 1110 254
  ◼1111 1111 255



### 5.1.2  二进制数的规律

- 画一个0-255 的数轴帮你记忆关键数值

  ![image-20210509152552414](计算机网络-韩立刚.assets/image-20210509152552414.png)

- 能够被2 整除的数，写成二进制形式，后一位是0 。如果余数是1 ，则最后一位是1。 

- 能够被4 整除的数，写成二进制形式，后两位是00 。如果余数是2 ，那就把2 写成二进制，后两位10。

- 能够够8 整除的数，写成二进制形式，最后三位是000 。如果余5 ，就把5 写成位二进制，后三位101。 

- 能够被16 整除的数，写成二进制形式，最后四位都是0000 。如果余6 ，就把6 写成二进制，最后四位0110。

  ![image-20210509153357480](计算机网络-韩立刚.assets/image-20210509153357480.png)

  

## 5.2  理解IP 地址

### 5.2.1 MAC 地址和IP 地址

- 数据包的**目标IP 地址**决定了数据包最终**到达哪一个计算机**，而**目标MAC 地址**决定了该数据包下一跳由**哪个设备接收**，不一定是终点。

  ![image-20210509153551447](计算机网络-韩立刚.assets/image-20210509153551447.png)

  

### 5.2.2 IP 地址的组成

- 32 位的二进制作为IP地址，其分为两部分，网络部分和主机部分。就像电话号码有区号和电话号一样。

  ![image-20210509153630944](计算机网络-韩立刚.assets/image-20210509153630944.png)

- 计算机的 IP 地址也有两部分组成，一部分为网络标识，一部分为主机标识，同一网段的计算机网络部分相同，路由器连接不同网段，负责不同网段之间的数据转发，交换机连接的是同一网段的计算机。

- 计算机在和其他计算机通信之前，首先要判断目标IP地 地址和自己的IP 地址是否在一个网段，这决定了数据链层的目标MAC 地址是目标计算机的还是路由器接口的MAC地址。

  ![image-20210509153711567](计算机网络-韩立刚.assets/image-20210509153711567.png)

  

### 5.2.3 IP 地址格式

- IP 地址用 **32 位二进制**来表示，也就是 32 比特，换算成字节，就是 **4 个字节**。

- 这些位通常被分割为4 个部分，每一部分 8 位二进制，中间使用符号“.” 分开，分成4 部分的二进制地址，10101100.00010000.00011110.00111000， ， IP 地址经常被写成十进制的形式，于是，上面的IP 地址可以表示为“172.16.30.56 ”。IP 地址的这种表示法叫做 “**点分十进制表示法**” 。

- 本书为了方便说明，将IP地址分为第1 部分，第2部 部分、第3 部分和第4 部分。

  ![image-20210509153912268](计算机网络-韩立刚.assets/image-20210509153912268.png)

  

### 5.2.4 子网掩码的作用

- **子网掩码（Subnet Mask ）**又叫网络掩码、地址掩码。

  - 它是一种用来指明一个IP地址的**哪些位标识的是主机所在的子网**以及**哪些位标识的是主机的位掩码**。
  - 子网掩码只有一个作用，就是将某个IP 地址划分成**网络地址**和**主机地址**两部分。

  ![image-20210509154131704](计算机网络-韩立刚.assets/image-20210509154131704.png)

- 使用自己的子网掩码计算机自己所在的网段。

  ![image-20210509154223855](计算机网络-韩立刚.assets/image-20210509154223855.png)

  

- 同一个网段的中的计算机子网掩码相同，计算机的网关就就是到其他网段的出口，也就是路由器接口地址。路由器接口使用的地址可以是本网段中任何一个地址，不过通常使用该网段的第一个可用的地址或最后一个可用的地址，这是为了尽可能避免和网络中的计算机地址冲突。

  ![image-20210509154421010](计算机网络-韩立刚.assets/image-20210509154421010.png)

  

## 5.3 IP 地址分类

### 5.3.1 A 类地址

- 网络地址的**最高位是0** 的地址为**A 类地址**。网络ID 是0 不能用，**127 作为保留网段**，因此A 类地址的第1 部分**取值范围1-126**。 

- A 类网络默认子网掩码为255.0.0.0 。主机ID 由第2 部分、第3 部分和第4部分组成，每部分的取值范围0-255 ，共256 种取值，你要是学过排列组合就知道，一个A 类网络主机数量是256 ×256 ×256=166777216 ，这里还需减去2 ，主机ID 全0 的地址为网络地址，而主机ID 全部为1 的地址为广播地址

  ![image-20210509154559490](计算机网络-韩立刚.assets/image-20210509154559490.png)

  

### 5.3.2 B 类地址

- 网络地址的**最高位是10** 的地址为**B 类地址**。IP 地址第1 部分的**取值范围为128-191**。 

- B 类网络默认子网掩码为255.255.0.0 。主机ID 由第3 部分和第4部分组成，每个B 类网络可以容纳的最大主机数量256 ×256-2=65023。

  ![image-20210509154639156](计算机网络-韩立刚.assets/image-20210509154639156.png)

  

### 5.3.3 C 类地址

- 网络地址的**最高位是110** 的地址为**C 类地址**。IP 地址第1 部分的**取值范围为192-223**。 

- C 类网络默认子网掩码为255.255.255.0 。主机ID 由第4 部分组成，每个C 类网络可以容纳的最大主机数量256-2=254。

  ![image-20210509154912473](计算机网络-韩立刚.assets/image-20210509154912473.png)

  

### 5.3.4 D 类和E 类地址

- 网络地址的**最高位是1110** 的地址为**D 类地址**。D 类地址第1 部分的**取值范围为224-239** 。用于多播（也称为组播）的地址，组播地址没有子网掩码。

  ![image-20210509154938392](计算机网络-韩立刚.assets/image-20210509154938392.png)

- 网络地址的**最高位是11110** 的地址为**E 类地址**。第一部分**取值范围240-254** ，保留为今后使用，在本书中并不讨论这些类型的地址（并且你也不要求了解这些内容）。

  ![image-20210509154957516](计算机网络-韩立刚.assets/image-20210509154957516.png)

- **IP地址分类助记图**

  ![image-20210509155110076](计算机网络-韩立刚.assets/image-20210509155110076.png)

  

### 5.3.5 保留的IP 地址

1. **主机ID 全为0 的地址：特指某个网段**，比如`192.168.10.0 255.255.255.0` ，指`192.168.10.0` 网段。
2. **主机ID 全为1 的地址：特指该网段的全部主机**，如果你的计算机发送数据包使用主机ID 全是1 的IP 地址，数据链层地址用广播地址`FF-FF-FF-FF-FF-FF`。 
3. `127.0.0.1` ：是 **本地环回地址** ，指**本机地址**，一般用来测试使用。回送地址(127.x.x.x) 是本机回送地址(Loopback Address) ，即 主机IP堆栈 内部的IP 地址 。
4. `169.254.0.0` ：`169.254.0.0-169.254.255.255` 实际上是**自动私有IP地址**。
5. `0.0.0.0` ：如果计算机的IP 地址和网络中的其他计算机**地址冲突**，使用ipconfig 命令看到的就是`0.0.0.0` ，子网掩码也是`0.0.0.0`



### 5.3.6 实战：本地环回地址

![image-20210509155458935](计算机网络-韩立刚.assets/image-20210509155458935.png)



### 5.3.7 实战：给本网段发送广播



## 5.4  私有地址和公网地址

### 5.4.1 公网地址

- 公有地址分配和管理由 **Inter NIC（Internet Network Information Center  因特网信息中心）**负责。各级ISP 使用的公网地址都需要向Inter NIC 提出申请，有Inter NIC 统一发放，这样就能确保地址块不冲突。
  - 公网地址全球统一规划，网段不能冲突和叠加。

### 5.4.2 私网地址

- 创建IP 寻址方案的人也创建了私网 IP 地址。这些地址可以被用于私有网络，在Internet 没有这些IP 地址，Internet 上的路由器也没有到私有网络的路由表。

- 下面是保留的私网地址。

  - A 类：`10.0.0.0 255.0.0.0` ，保留了**一个A 类网络**。
  - B 类：`172.16.0.0 255.255.0.0 ～172.31.0.0 255.255.0.0` ，保留了**16 个B 类网络。**
  - C 类：`192.168.0.0 255.255.255.0 ～192.168.255.0 255.255.255.0` ，保留了**256 个C类网络。**

- 私网地址访问Internet 需要 **NAT** 或**PAT**

  ![image-20210509155910845](计算机网络-韩立刚.assets/image-20210509155910845.png)

  

## 5.5  等长子网划分

### 5.5.1 地址浪费

- 按着IP 地址传统的分类方法，一个网段有200 台计算机，分配一个C 类网络，`212.2.3.0 255.255.255.0` ，可用的地址范围`212.2.3.1—212.2.3.254` ，虽然没有全部用完，这种情况还不算是极大浪费。

- 如果一个网络中有400 台计算机，分配一个C 类网络，地址就不够用了，那就分配一个B 类网络，`131.107.0.0 255.255.0.0` ，该B 类网络可用的地址范围``131.107.0.1—`
  131.107.255.254` ，一共有56634 个地址可用，这就造成了极大浪费。

  ![image-20210509160130211](计算机网络-韩立刚.assets/image-20210509160130211.png)

  

### 5.5.2 等长子网划分

- 子网划分，就是借用现有网段的主机位做子网位，划分出多个子网。子网划分的任务包括两部分：
- 等长子网划分就是将**一个网段等分成多个网段**，也就是等分成多个子网。
  - **确定子网掩码的长度。**
  - **确定子网中第一个可用的IP 地址和最后一个可用的IP 地址。**

1. **等分成两个子网**

   ![image-20210509160301227](计算机网络-韩立刚.assets/image-20210509160301227.png)

   ![image-20210509160438123](计算机网络-韩立刚.assets/image-20210509160438123.png)

   - A 和B 两个子网的子网掩码都为`255.255.255.128`。 
   - A 子网可用的地址范围为`192.168.0.1 ～192.168.0.126` ，IP 地址`192.168.0.0` 由于主机位全为0 ，不能分配给计算机使用，如图5-36 所示，`192.168.0.127` 由于其主机位全为1 ，不能分配计算机。

   ![image-20210509160556407](计算机网络-韩立刚.assets/image-20210509160556407.png)

2. **等分成四个子网**

   1. 要想分成4 个子网，你需要将子网掩码往右移动两位，这样第1 位和第2 位就变为网络位。你就可以分成4 个子网，第1 位和第2 位为00 是A 子网，01 是B 子网，10 是C子网，11 是D 子网。

      ![image-20210509160657598](计算机网络-韩立刚.assets/image-20210509160657598.png)

   2. 每个子网的最后一个地址都是本子网的广播地址，不能分配给计算机使用，的A 子网的63 、B 子网的127 、C 子网的191 和D子网的255。

      ![image-20210509160739839](计算机网络-韩立刚.assets/image-20210509160739839.png)

3. **等分为八个子网**

   1. 把一个C 类网络等分成8 个子网，如图5-40 所示，子网掩码需要往右移3 位。才能划分出8 个子网，第1 位、第2 位和第3 位都变成网络位。

      ![image-20210509162835318](计算机网络-韩立刚.assets/image-20210509162835318.png)

      

### 5.5.3 B 类网络子网划分

- 将`131.107.0.0 255.255.0.0` 等分成2 个子网。子网掩码往右移动1 位，就能等分成两个子网。

  ![image-20210509162956466](计算机网络-韩立刚.assets/image-20210509162956466.png)

  ![image-20210509163023694](计算机网络-韩立刚.assets/image-20210509163023694.png)

  

### 5.5.4 A 类地址子网划分

- A 类网络42.0.0.0 255.0.0.0 等分成4 个子网为例，写出各个子网的第一个和最后一个可用的IP 地址。

  ![image-20210509163110827](计算机网络-韩立刚.assets/image-20210509163110827.png)

- 每个子网第一个和最后一个可用地址

  ![image-20210509163129258](计算机网络-韩立刚.assets/image-20210509163129258.png)

  

## 5.6  变长子网划分

### 5.6.1 变长子网划分

- 每个子网的子网掩码取决于该地址块是除了几次2 的到的。

  - 除一次2 ，子网掩码增加一位1。

  ![image-20210509163234173](计算机网络-韩立刚.assets/image-20210509163234173.png)

  

- **变长子网划分规律**

  - 规律：如果一个子网地址块是原来网段的 $(\displaystyle \frac{1}{2})^n$，子网掩码就在原网段的基础上后移 n 位，不等长子网 ， 子网掩码也不同。

  ![image-20210509163410811](计算机网络-韩立刚.assets/image-20210509163410811.png)



### 5.6.2 点到点网络的子网掩码

- 每个子网是原来网络的$\frac{1}{2}\times  \frac{1}{2}\times  \frac{1}{2}\times  \frac{1}{2}\times  \frac{1}{2}\times  \frac{1}{2}$ 也就是$(\frac{1}{2})^6$

- 子网掩码向后移动6 位，`11111111.11111111.11111111.11111100` 写成十进制子网掩码也就是`255.255.255.252`。

  ![image-20210509163615923](计算机网络-韩立刚.assets/image-20210509163615923.png)

  

### 5.6.3 子网掩码另一种表示方法-CIDR

- IP 地址有“**类**”的概念，A 类地址默认子网掩码255.0.0.0 、B 类地址默认子网掩码255.255.0.0 、C 类地址默认子网掩码255.255.255.0 。

  - 等长子网划分和变长子网划分，打破了IP 地址“类”的概念，子网掩码也打破了字节的限制，这种子网掩码被称为**VLSM （Variable Length SubnetMasking ，可变长子网掩码）**

- 这种方式的也可以使得Internet 上的路由器路由表大大精简，被称为**CIDR （无类域间路由，Classless Inter-Domain Routing ）**，子网掩码中1的个数被称为CIDR 值。

- 子网掩码的二进制写法以及相对应的**CIDR的斜线表示**

  ![image-20210509163747620](计算机网络-韩立刚.assets/image-20210509163747620.png)

  ![image-20210509163821604](计算机网络-韩立刚.assets/image-20210509163821604.png)

  

### 5.6.4 判断IP 地址所属的网段

- IP 地址中主机位归 0 就是该主机所在的网段。

  - 判断192.168.0.101/26 所属的子网。

  ![image-20210509163843531](计算机网络-韩立刚.assets/image-20210509163843531.png)

- 判断192.168.0.101/27 所属的子网。

  ![image-20210509163956716](计算机网络-韩立刚.assets/image-20210509163956716.png)

- **总结**

  ![image-20210509164025840](计算机网络-韩立刚.assets/image-20210509164025840.png)

  

### 5.6.5 子网划分需要注意几个问题

- 子网划分需要注意的几点：

  - 将一个网络等分成2 个子网，每个子网肯定是原来的一半。

    ![image-20210509164105515](计算机网络-韩立刚.assets/image-20210509164105515.png)

  - 子网地址范围不可重叠

    ![image-20210509164129801](计算机网络-韩立刚.assets/image-20210509164129801.png)

    

## 5.7  超网合并网段

### 5.7.1 合并网段

- 某企业有一个网段，该网段有200 台计算机，使用`192.168.0.0 255.255.255.0` 网段，后来计算机数量增加到400 台。

  ![image-20210509164236360](计算机网络-韩立刚.assets/image-20210509164236360.png)

- 有没有更好的办法，让这两个C 类网段的计算机认为在一个网段？这就需要将192.168.0.0/24 和192.168.1.0/24  两个C 类网络合并。

  ![image-20210509164300398](计算机网络-韩立刚.assets/image-20210509164300398.png)

- **合并网段的规律**

  - 合并之后，IP 地址`192.168.0.255/23` 就可以给计算机使用

    ![image-20210509164340694](计算机网络-韩立刚.assets/image-20210509164340694.png)

    

  - 规律：**子网掩码往左移1 位，能够合并两个连续的网段，但不是任何连续的网段都能合并。**

  

### 5.7.2 不是任何连续的网段都能合并

- `192.168.1.0/24 和 192.168.2.0/24`  两个网段就不能通过向前移动一位子网掩码而合并。

  ![image-20210509164511105](计算机网络-韩立刚.assets/image-20210509164511105.png)

  

  - 移动两位能够合并成一个网段，实际上合并了4 个网段。

  ![image-20210509164528552](计算机网络-韩立刚.assets/image-20210509164528552.png)

  

### 5.7.3 哪些连续的网段能够合并

- 判断两个子网是否能够合并。

  ![image-20210509164706908](计算机网络-韩立刚.assets/image-20210509164706908.png)

  

- 结论：判断连续的2 个网段是否能够合并，只要第一个网络号能被2 整除，就能够通过左移1位子网掩码合并。

1. 思考:

   - 131.107.31.0/24 和131.107.32.0/24 是否能够左移1 位子网掩码合并？
     - 否
   - 131.107.142.0/24 和131.107.143.0/24 是否能够左移1 位子网掩码合并？
     - 是

2. 判断4个网段是否能合并

   ![image-20210509164902378](计算机网络-韩立刚.assets/image-20210509164902378.png)

   - 规律：要合并连续的四个网络，只要第一个网络的网络号写成二进制后面两位是00 ，这四个网段就能合并，根据5.1.2讲 讲到的二进制数的规律，只要一个数能够被4 整除，写成二进制最后两位肯定是00。
   - **结论：**判断连续的4 个网段是否能够合并，只要**第一个网络号能被4 整除**，就能够通过左移2 位子网掩码合并将这4 个网段合并。
   - 依次类推，要想判断连续的8 个网段是否能够合并，只要**第一个网络号能被8 整除**，这8 个连续的网段就能够通过左移3 位子网掩码合并。

3. 思考：

   - 判断 `131.107.232.0/24 、131.107.233.0/24 、131.107.234.0/24 和131.107.235.0/24` 这四个网段是否能够左移2 位子网掩码合并成一个网段。
     - 能

### 5.7.4 网段合并的规律

- **网段合并的规律，子网掩码左移1 位能够将能够合并两个网段，左移2位，能够合并四个网段，左移3 位，能够合并8 个网段。**

  ![image-20210509165106289](计算机网络-韩立刚.assets/image-20210509165106289.png)

### 5.7.5 判断一个网段是超网还是子网

1. 通过左移子网掩码合并多个网段，右移子网掩码将一个网段划分成多个子网，使得IP 地址打破了传统的A 类、B 类、C 类的界限。
2. 判断一个网段到底是子网还是超网，就要看该网段是A 类网络、还是B 类网络、还是C 类网络，默认A 类子网掩码/8 ，B类子网掩码是/16 ，C 类子网掩码是/24。
3. 如果**该网段的子网掩码比默认子网掩码长，就是子网**，如果**该网段的子网掩码比默认子网掩码短，则是超网**。



思考

1. `12.3.0.0/16` 这是A 类网络还是C 类网络呢？是超网还是子网呢？
2. IP 地址的第一部分是12 ，这是一个A 类网络，A 类地址默认子网掩码是/8 ，该网络的子网掩码是/16 ，比默认子网掩码长，所以说这是A 类网的一个子网。
3. `222.3.0.0/16` 这是C 类网络还是B 类网络呢？是超网还是子网呢？

# 第6章 静态路由和动态路由

5小时18分钟28节

6-1 网络层实现的功能 05:42 
6-2 网络畅通的条件 11:14 
6-3 静态路由 07:13 
6-4 搭建静态路由实验环境 14:10 
6-5 实战:添加静态路由 18:05 
6-6 添加静态路由需要注意的两个地方 09:54 
6-7 路由汇总 14:08 
6-8 路由汇总例外和**汇总 08:48 
6-9 全球最大的网段和默认路由 06:30 
6-10 默认路由指向Internet 08:33 
6-11 让默认路由代表大多数网段 12:20 
6-12 Internet上路由器的路由表 10:08 
6-13 管理Windows系统上的路由 16:50 
6-14 排查路由引起的网络故障 11:54 
6-15 动态路由协议-RIP协议 18:06 
6-16 搭建RIP协议实验环境 23:03 
6-17 配置RIP协议 11:46 
6-18 RIP协议network的作用 16:48 
6-19 跟踪RIP协议工作过程 06:43 
6-20 验证RIP协议的健壮性 10:49 
6-21 RIP协议数据包格式 05:41 
6-22 介绍OSPF协议 09:10 
6-23 OSPF协议术语和OSPF协议工作过程 15:37 
6-24 OSPF支持多区域 06:40 
6-25 配置OSPF协议 09:31 
6-26 查看OSPF协议邻居表 链路状态表 路由表 16:30 
6-27 验证OSPF协议健壮性 04:36 
6-28 本章总结 08:09 

## 6.1 IP 路由- 网络层实现的功能

- 网络层功能就是给传输层协议提供简单灵活的、无连接的、尽最大努力交付的数据包服务。
  - 通俗一点来讲，网络中的路由器为每一个数据包单独的选择转发路径，网络层不提供服务质量的承诺 。
  - 也就说路由器直接丢弃传输过程中出错的数据包，如果网络中待发的数据包太多，路由器处理不了就直接丢弃，路由器也不判断数据包是否重复，也不确保数据包按发送顺序到达终点。

![image-20210509170254633](计算机网络-韩立刚.assets/image-20210509170254633.png)



### 6.1.1  网络畅通的条件

- 计算机网络畅通的条件就是数据包能去能回，道理很简单、也很好理解，却是我们排除网络故障的理论依据。

  ![image-20210509170420932](计算机网络-韩立刚.assets/image-20210509170420932.png)

- 以下情况网络不通

  - 目标主机不可到达

    ![image-20210509170448398](计算机网络-韩立刚.assets/image-20210509170448398.png)

    

  - 请求超时

    ![image-20210509170459758](计算机网络-韩立刚.assets/image-20210509170459758.png)

    

- **网络排错**

  - 明白了网络畅通的条件 ，网络排错就变得简单了。
    - 先检查数据包是否能够到达目标网络
    - 再检查数据包是否能够返回来。
    - 如果网络不通，您就要检查计算机是否配置了正确的IP 地址子网掩码以及网关，再逐一检查沿途路由器上的路由表，查看是否有到达目标网络的路由；
    - 然后逐一检查沿途路由器上的路由表，检查是否有数据包返回所需的路由。

  

### 6.1.2  静态路由

- 要想实现全网通信，也就是网络中的任意两个节点都能通信，这就要求每个路由器的**路由表中必须有到所有网段的路由**。
- 对于路由器来说，它只知道自己直连的网段，对于没有直连的网段，需要管理员人工添加到这些网段到路由。
  - **管理员人工添加到某个网段如何转发，就是静态路由**。
- 后面还会讲到配置网络中的路由器使用**动态路由协议（RIP、 OSPF）自动构建路由表，就是动态路由。**



1. 思科路由器添加静态路由的命令

   1.  R1 路由器直连A、 B 两个网段，C 、D网段没有直连，你需要添加到C 、D 网段的路由。
   2. R2 路由器直连B 、C两个网段，A 、D网段没有直连，你需要添加到A 、D 网段的路由。
   3. R3 路由器直连C、 D 两个网段，A 、B网段没有直连，你需要添加到A 、B 网段的路由。

   ![image-20210509170832442](计算机网络-韩立刚.assets/image-20210509170832442.png)

2. 点到点链路静态路由下一跳

   1. 点到点链路下一跳可以是数据包的转发出口

      ![image-20210509171048701](计算机网络-韩立刚.assets/image-20210509171048701.png)

   2. 在 在R1 上添加到192.168.1.0/24 网段的路由可以使用以下命令 `R1(config)#ip route 192.168.1.0 255.255.255.0 serial 2/0`

   3. 注意：Serial 2/0 是路由器R1 接口

3. 路由器只关心到某个网段如何转发

   1. 路由器只关心到某个网段如何转发数据包，因此我们在路由器上添加路由，必须是到某个网段（子网）的路由，不能添加到某个特定地址的路由。
   2. 以下命令试图添加到一个IP 地址的路由，路由器报错。
      - `R1(config)#ip route 192.168.1.3 255.255.255.0 172.16.0.2`
      - `%Inconsistent address and mask -- 错误的地址和子网掩码`
   3. 如果你就想让路由器转发到一个IP 地址的路由，子网掩码要写成四个255 ，这就意味着IP 地址的32 位二进制是全部的网络位，该网段中就这一个地址。
      - `R1(config)#ip route 192.168.1.3 255.255.255.255 172.16.0.2`



## 6.2  实战：配置静态路由

![image-20210509171305398](计算机网络-韩立刚.assets/image-20210509171305398.png)

### 6.2.1 查看路由表



### 6.2.2 添加静态路由

### 6.2.3 测试网络是否畅通

### 6.2.4 删除静态路由



## 6.3  路由汇总

- Internet 是全球最大的互联网，如果Internet 上的路由器把全球所有的网段都添加到路由表，那将是一个非常庞大的路由表。路由器每转发一个数据包，都要检查路由表为该数据包选择转发接口，庞大的路由表势必会增加处理时延。
- 通过合理的地址规划，可以 通过路由汇总简化路由表 。
- 将物理位置连续的网络分配地址连续的网段，就可以在边界路由器上将远程的网络合并成一条路由，这就是路由汇总。

### 6.3.1通过路由汇总简化路由表

1. 不汇总的路由表

   ![image-20210509171428563](计算机网络-韩立刚.assets/image-20210509171428563.png)

2. 汇总后的路由表

   ![image-20210509171451840](计算机网络-韩立刚.assets/image-20210509171451840.png)

3. 将北京的网络汇总成 `172.0.0.0 255.0.0.0` 网段。

   ![image-20210509171529730](计算机网络-韩立刚.assets/image-20210509171529730.png)

   

### 6.3.2路由汇总例外

- 针对例外的网段需要单独添加路由。

  ![image-20210509171607714](计算机网络-韩立刚.assets/image-20210509171607714.png)

  

### 6.3.3 无类域间路由（CIDR）

1. 无类域间路由（CIDR ）采用13 ～27 位可变网络ID ，而不是A、 、B 、C 类网络ID 所用的固定的8 、16 和24 位。
   - 这样我们可以将子网掩码向左移动1 位，合并两个网段；向左移动2 位合并4 个网段；向左移动3 位合并8 个网段；向左移动n位，就可以合并$2 ^n$ 个网段。
2. 路由汇总一定要能够想起前面讲的超网合并网段，对于R2 路由器来说A 区的就相当于一个合并了四个网段的超网。

![image-20210509171709991](计算机网络-韩立刚.assets/image-20210509171709991.png)



## 6.4  默认路由

### 6.4.1 全球最大的网段

- 我们在路由器上添加以下三条路由。
  - `R1(config)#ip route 172.0.0.0 255.0.0.0 10.0.0.2 -- 第1 条路由`
  - `R1(config)#ip route 172.16.0.0 255.255.0.0 10.0.1.2 -- 第2 条路由`
  - `R1(config)#ip route 172.16.10.0 255.255.255.0 10.0.3.2 -- 第3 条路由`
  - 从上面3 条路由可以看出，子网掩码越短（子网掩码写成二进制形式1 的个数越少），主机位越多，该网段的地址数量就越大。
- 如果想让一个网段包括全部的IP 地址，这就要求子网掩码短到极限，最短就是0 ，子网掩码变成了0.0.0.0 ，这就意味着该网段的32位二进制的IP 地址都是主机位，任何一个地址都属于该网段。因此 此0.0.0.0  子网掩码0.0.0.0 网段包括了全球所有IPv4 地址，也就是全球最大的网段，换一种写法就是0.0.0.0/0。
  - 在路由器上添加添加到0.0.0.0 0.0.0.0 网段的路由，就是默认路由。
  - `R1(config)#ip route 0.0.0.0 0.0.0.0 10.0.0.2 -- 第4 条路由`
  - 任何一个目标地址都与默认路由匹配，根据前面讲的“最长前缀匹配”算法，默认路由是在路由器没有为数据包找到更为精确匹配的路由，最后匹配的一条路由。



### 6.4.2 使用默认路由作为指向Internet 的路由

- 网络末端路由器B 和D 只需添加一条默认路由。

  ![image-20210509171940153](计算机网络-韩立刚.assets/image-20210509171940153.png)

  

- RA路由器上的路由表也可以精简

  - 在 在A 路由器上可以把内网看做是10.0.0.0 255.0.0.0 这个网段。所以只需添加一条路由。

  ![image-20210509172041047](计算机网络-韩立刚.assets/image-20210509172041047.png)



### 6.4.3 让默认路由代替大多数网段的路由

- 对于C 路由器来说，1 和2 两种方式都可以，但1 这种方式路由条目更少。

![image-20210509172118103](计算机网络-韩立刚.assets/image-20210509172118103.png)



### 6.4.4 默认路由和环状网络

![image-20210509172137497](计算机网络-韩立刚.assets/image-20210509172137497.png)



### 6.4.5 默认路由造成的往复转发

![image-20210509172152991](计算机网络-韩立刚.assets/image-20210509172152991.png)



### 6.4.6 使用默认路由和路由汇总简化路由表

![image-20210509172217635](计算机网络-韩立刚.assets/image-20210509172217635.png)

![image-20210509172234019](计算机网络-韩立刚.assets/image-20210509172234019.png)



### 6.4.7Windows 上的默认路由和网关

- 计算机也有路由表，我们可以在Windows 操作系统上运行`route print`显示Windows 操作系统上的路由表，也可以运行`netstat –r` 显示Windows操作系统上的路由表。

  ![image-20210509172308855](计算机网络-韩立刚.assets/image-20210509172308855.png)

  ![image-20210509172339816](计算机网络-韩立刚.assets/image-20210509172339816.png)

  

- 在Windows上添加默认路由

  ![image-20210509172406873](计算机网络-韩立刚.assets/image-20210509172406873.png)

  

- 在Web服务器上需要添加到内网的路由

  ![image-20210509172429895](计算机网络-韩立刚.assets/image-20210509172429895.png)

  - 如果想删除到172.16.0.0 255.255.255.0 网段的路由 ， 指向以下命令 。
  - `route delete 172.16.0.0 mask 255.255.255.0`



## 6.5  网络排错案例

### 6.5.1 网络排错要有全局观

1. 网络出现不通的故障，要确保数据包有去有回，确保沿途的路由知道源和目标网络的路由。

2. 出现网络故障，不要只检查自己所管辖的网络。也要确保远程网络中的路由器的路由表，有返回的路由。

   ![image-20210509172533879](计算机网络-韩立刚.assets/image-20210509172533879.png)

   

### 6.5.2 计算机网关也很重要

- 计算机不设置网关，只能和本网段的计算机通信。

![image-20210509172559702](计算机网络-韩立刚.assets/image-20210509172559702.png)



## 6.6  动态路由-RIP 协议

### 6.6.1 RIP 协议

1. **路由信息协议RIP （Routing Information Protocol ）**是一个真正的距离矢量路由选择协议。
   1. 它每隔30 秒就送出自己完整的路由表到所有激活的接口。
   2. RIP 协议选择最佳路径的标准就是跳数，认为到达目标网络经过的路由器最少的路径就是最佳路径。
   3. 默认它所允许的最大跳数为15 跳，也就是说16 跳的距离将被认为是不可达的。
   4. 在小型网络中，RIP 会运转良好，但是对于使用慢速WAN 连接的大型网络或者安装有大量路由器的网络来说，它的效率就很低了。



### 6.6.2 RIP 协议工作原理

![image-20210509172735208](计算机网络-韩立刚.assets/image-20210509172735208.png)



### 6.6.3 在路由器上配置RIP 协议

1. 搭建实验环境

   ![image-20210509172755615](计算机网络-韩立刚.assets/image-20210509172755615.png)

2. 在R1上的配置

   ```shell
   R1#config t
   Enter configuration commands, one per line. End with CNTL/Z.
   R1(config)#router rip
   R1(config-router)#network 192.168.0.0
   R1(config-router)#network 192.168.1.0
   R1(config-router)#network 192.168.4.0
   R1(config-router)#version 2
   ```

3. network的应该怎么写

   1. 就要看接口属于哪个网络，多个接口属于同一个网段（按A、 、B 、C 分类），只需写一个。

   ![image-20210509172938847](计算机网络-韩立刚.assets/image-20210509172938847.png)

   



### 6.6.4 查看路由表

```shell
R3#show ip route
R 192.168.4.0/24 [120/2] via 192.168.6.1, 00:00:08, Serial2/0
[120/2] via 192.168.2.1, 00:00:02, Serial2/1
R 192.168.5.0/24 [120/1] via 192.168.6.1, 00:00:08, Serial2/0
C 192.168.6.0/24 is directly connected, Serial2/0
R 192.168.0.0/24 [120/2] via 192.168.2.1, 00:00:02, Serial2/1
R 192.168.1.0/24 [120/1] via 192.168.2.1, 00:00:02, Serial2/1
C 192.168.2.0/24 is directly connected, Serial2/1
C 192.168.3.0/24 is directly connected, FastEthernet0/0
```



- 路由条目的详细说明

  - 管理距离是指一种路由协议的路由可信度。每一种路由协议按可靠性从高到低，依次分配一个信任等级，这个信任等级就叫管理距离（administrative distance， ，缩写：AD ）。
  - AD 值越低，则它的优先级越高。  一个管理距离是一个从0-255 的整数值，0 是最可信赖的，而255 则意味着不会有业务量通过这个路由。
  - 默认情况下的管理距离值 ：直连接口 0 ， 由 静态路由 1 ，OSPF 110 ，RIP 120

  ![image-20210509173059447](计算机网络-韩立刚.assets/image-20210509173059447.png)

  



### 6.6.5 观察RIP 协议路由更新活动

- 默认情况下RIP 协议发送和接收路由更新信息以及构造路由表的细节是不显示的，

  - 如果我们想观察RIP 协议路由更新的活动，可以输入命令`debug ip rip`  命令，输入该命令后将显示发送和接收到的RIP 路由更新信息，显示路由器使用了RIP 的V1 版还是V2 版本。可以看到发送路由消息使用的多播地址是224.0.0.9，   输入`undebug all` 关闭所有诊断输出。

  ```shell
  R3#debug ip rip
  RIP protocol debugging is on
  *Mar 1 01:22:52.703: RIP: sending v2 update to 224.0.0.9 via FastEthernet0/0
  (192.168.3.1
  *Mar 1 01:22:52.703: RIP: build update entries -- 更新路由表
  *Mar 1 01:22:52.703: 192.168.0.0/24 via 0.0.0.0, metric 3, tag 0
  *Mar 1 01:22:52.703: 192.168.1.0/24 via 0.0.0.0, metric 2, tag 0
  *Mar 1 01:22:52.703: 192.168.2.0/24 via 0.0.0.0, metric 1, tag 0
  ```

  



### 6.6.6 测试RIP 协议健壮性

- 动态路由协议会随着网络的变化重新生成到各个网络的路由，当最佳路径没有了，就会从备用路径中重新选择一个最佳路径

  

### 6.6.7 RIP 协议排错

1. 如果网络中的路由配置了RIP 协议，但没有从邻居路由器学习到路由，就要测试网络中的直连的路由之间是否能够通信，确保IP 地址子网掩码配置正确，路由器使用串口相连，还要确保在DCE 端配置了时钟频率。

2. 再就是检测RIP 协议是否配置正确，网络中的路由最好都使用相同版本的RIP 协议，Network 命令后面的网段是否正确。

3. 查看路由器上的RIP 协议配置，输入`show ip protocols`。

   ```shell
   R1#show ip protocols
   Routing Protocol is "rip"
   Maximum path: 4
   Routing for Networks:
   192.168.0.0
   192.168.1.0
   192.168.4.0
   Routing Information Sources:
   Gateway Distance Last Update
   192.168.1.2 120 00:00:06
   192.168.4.2 120 00:00:23
   Distance: (default is 120)
   ```

   

### 6.6.8RIP 协议数据包报文格式

![image-20210509173315374](计算机网络-韩立刚.assets/image-20210509173315374.png)

![image-20210509173329352](计算机网络-韩立刚.assets/image-20210509173329352.png)





## 6.7  动态路由-OSPF 协议

### 6.7.1 什么是最短路径优先

1. 最短路径优先 示意图

   ![image-20210509173427384](计算机网络-韩立刚.assets/image-20210509173427384.png)

2. 计算最短路径

   ![image-20210509173458577](计算机网络-韩立刚.assets/image-20210509173458577.png)

   

### 6.7.2 OSPF 术语

1. **outer-ID**
   - 网络中运行OSPF 协议的路由器都要有一个唯一的标识，这就是Router-ID ，并且Router-ID 在网络中绝对不可以有重复 。
2. **COST （开销）**
   - OSPF 协议选择最佳路径的标准是带宽，带宽越高计算出来的开销越低。到达目标网络的各个链路累计开销最低的，就是最佳路径。
3. **链路（Link）**
   - 就是路由器上的接口，在这里，应该指运行在OSPF 进程下的接口。
4. **链路状态（Link-State）**
   - 链路状态（LSA） 就是OSPF 接口上的描述信息，例如接口上的IP 地址，子网掩码，网类型，Cost 值等等，OSPF 路由器之间交换的并不是路由表，而是链路状态（LSA） 。
5. **邻居（Neighbor）**
   - OSPF 只有邻接状态才会交换LSA。



### 6.7.3OSPF 协议工作过程

- 运行OSPF 协议的路由器有3 张表，邻居表、链路状态表和路由表。下面以这三张表的产生过程为线索，来分析在这个过程中，路由器发生了那些变化，从而说明OSPF 协议的工作过程。

  ![image-20210509173656882](计算机网络-韩立刚.assets/image-20210509173656882.png)

  

### 6.7.4 OSPF 的5 种报文

1. 类型1 ，**问候（Hello ）**数据包，发现并建立邻接关系。
2. 类型2 ，**数据库描述（Database Description ）**数据包，向邻居给出自己的链路状态数据库中的所有链路状态项目的摘要信息。
3. 类型3 ，**链路状态请求（Link State Request ，LSR ）**数据包，向对方请求某些链路状态项目的完整信息。
4. 类型4 ，**链路状态更新（Link State Update ，LSU ）**数据包，用洪泛法对全网更新链路状态。这种数据包是最复杂的，也是OSPF 协议最核心的部分。路由器使用这种数据包将其链路状态通知给相邻路由器。在OSPF 中，只有LSU 需要显示确认。
5. 类型5 ，**链路状态确认（Link State Acknowledgement ，LSAck ）**数据包，对LSU 做确认。



### 6.7.5OSPF 支持多区域

- 划分区域的好处就是把利用洪泛法交换链路状态信息的范围局限于每一个区域而不是整个的自治系统，这就减少了整个网络上的通信量。在一个区域内部的路由器只知道本区域的完整网络拓扑，而不需知道其他区域的网络拓扑的情况。

  ![image-20210509173811953](计算机网络-韩立刚.assets/image-20210509173811953.png)

  



## 6.8  配置OSPF

本节实验环境 配置OSPF协议

![image-20210509173905478](计算机网络-韩立刚.assets/image-20210509173905478.png)



### 6.8.1 配置OSPF 协议

```shell
R1#config t
Enter configuration commands, one per line. End with CNTL/Z.
R1(config)#router ospf ?
 <1-65535> Process ID
R1(config)#router ospf 1
R1(config-router)#network 192.168.0.0 0.0.0.255 area 0
R1(config-router)#network 192.168.1.0 0.0.0.255 area 0
R1(config-router)#network 192.168.4.0 0.0.0.255 area 0
R1(config-router)#
```



### 6.8.2 查看OSPF 协议三张表

```shell
R1#show ip ospf neighbor -- 显示邻居表
Neighbor ID Pri State Dead Time Address Interface
192.168.5.1 0 FULL/ - 00:00:37 192.168.4.2 Serial2/1
192.168.2.1 0 FULL/ - 00:00:34 192.168.1.2 Serial2/0
R1#show ip ospf neighbor detail -- 显示邻居详细信息
R1#show ip ospf database -- 显示链路状态数据库
R1#show ip ospf database router -- 显示完整的链路状态数据库
R1#show ip route ospf -- 只显示OSPF 协议学到的路由
```



### 6.8.3 监控OSPF 协议的活动

```shell
R1#debug ip ospf hello
R1#undebug all
```



### 6.8.4 验证OSPF 协议健壮性

1. 断开最佳连接，跟踪数据包路径。
2. 恢复最佳连接，跟踪数据包路径。
3. 看看在此期间，网络中断的时间。



### 6.8.5 OSPF 协议配置排错

```shell
R1#show ip protocols -- 显示OSPF 协议的配置
Routing Protocol is "ospf 1"
Outgoing update filter list for all interfaces is not set
Incoming update filter list for all interfaces is not set
Router ID 192.168.4.1
Number of areas in this router is 1. 1 normal 0 stub 0 nssa
Maximum path: 4
Routing for Networks:
192.168.0.0 0.0.0.255 area 0
192.168.1.0 0.0.0.255 area 0
192.168.4.0 0.0.0.255 area 0
Reference bandwidth unit is 100 mbps
Routing Information Sources:
Gateway Distance Last Update
192.168.2.1 110 00:13:59
192.168.5.1 110 00:13:59
192.168.6.2 110 00:13:59
192.168.6.1 110 00:13:59
Distance: (default is 110)
```



# 第7章 网络层协议

4小时49分钟26节

7-1 网络层协议本章重点 07:15 
7-2 网络层首部 06:10 
7-3 网络层首部-版本和首部长度 11:41 
7-4 网络层首部-区分服务 17:12 
7-5 网络层首部-总长度 09:40 
7-6 网络层首部-分片标志 11:40 
7-7 网络层首部-片偏移 18:47 
7-8 网络层首部-生存时间 13:45 
7-9 抓包观察数据包TTL变化 08:30 
7-10 网络层首部-协议号 05:33 
7-11 ICMP差错报告报文-TTL耗尽和目标主机不可到达 09:49 
7-12 ICMP协议数据包类型 10:57 
7-13 网络层首部-标识 04:24 
7-14 ICMP差错报告报文-路由重定向 11:51 
7-15 ICMP差错报告报文格式 05:40 
7-16 ICMP差错报告报文-给应用程序返回差错报告 07:01 
7-17 使用ping命令测试网络是否畅通 12:45 
7-18 跟踪数据包路径-tracert和pathping 12:13 
7-19 ARP协议的作用 09:18 
7-20 ARP欺骗 25:19 
7-21 防止ARP欺骗 12:02 
7-22 组播（多播）应用场景 11:39 
7-23 搭建点播和多播视频服务器 09:57 
7-24 多播IP地址和多播MAC地址 09:23 
7-25 IGMP协议功能 04:12 
7-26 配置跨网段多播看视频 23:09 



![image-20210509175130321](计算机网络-韩立刚.assets/image-20210509175130321.png)



## 7.1  网络层首部

### 7.1.1 抓包查看网络层首部

![image-20210510162707073](计算机网络-韩立刚.assets/image-20210510162707073.png)



### 7.1.2 网络层首部格式

- IP 数据包首部的格式能够说明IP 协议都具有什么功能。

- IP 数据包由首部和数据两部分组成。首部的前一部分是固定长度，共20 个字节，是所有IP 数据包必须有的。在首部的固定部分的后面是一些可选字段，其长度是可变的。

  ![image-20210510162738389](计算机网络-韩立刚.assets/image-20210510162738389.png)

- 网络层首部固定部分各个字段(1)

  1. **版本占4 位，指IP 协议的版本**。IP 协议目前有两个版本IPv4和 和IPv6 。通信双方使用的IP 协议版本必须一致。目前广泛使用的IP协议版本号为4 （即IPv4 ）。

  2. **首部长度占4 位**，可表示的最大十进制数值是15 。请注意，这个字段所表示数的单位是32 位二进制数（即4 个字节），因此，当IP 的首部长度为1111 时（即十进制的15 ），首部长度就达到60字节。

  3. **区分服务占8 位**，配置计算机给特定应用程序的数据包添加一个标志，然后再配置网络中的路由器优先转发这些带标志的数据包，在网络带宽比较紧张的情况下，也能确保这种应用的带宽有保障，这就是区分服务，为这种服务确保服务质量（Qualityof Service ，QoS ）。

  4. **总长度**:  总长度指IP 首部和数据之和的长度，也就是数据包的长度，单位为字节。总长度字段为**16 位**，因此数据包的最大长度为$2 ^{16} -1=65535 $字节。实际上传输这样长的数据包在现实中是极少遇到的。

     ![image-20210510162949170](计算机网络-韩立刚.assets/image-20210510162949170.png)

  5. **标识（identification）占16 位**。IP 软件在存储器中维持一个计数器，每产生一个数据包，计数器就加1 ，并将此值赋给标识字段。但这个“标识”并不是序号，因为IP 是无连接服务，数据包不存在按序接收的问题。当数据包由于长度超过网络的MTU 而必须分片时，同一个数据包被分成多个片，这些片的标识都一样，也就是数据包这个标识字段的值就被复制到所有的数据包分片的标识字段中。相同的标识字段的值使分片后的各数据包片最后能正确地重装成为原来的数据包。

  6. **标志（flag）占3 位**，但目前只有两位有意义。标志字段中的最低位记为MF （More Fragment ）。MF=1 即表示后面“还有分片”的数据包。MF=0 表示这己是若干数据包片中的最后一个。标志字段中间的一位记为DF （Don’t Fragment ），意思是“不能分片”。只有当DF=0 时才一允许分片。

  7. **片偏移占13 位**。片偏移指出：较长的分组在分片后，某片在原分组中的相对位置。也就是说，相对于用户数据字段的起点，该片从何处开始。片偏移以8 个字节为偏移单位。这就是说，每个分片的长度一定是8 字节（64 位）的整数倍。

     ![image-20210510163121194](计算机网络-韩立刚.assets/image-20210510163121194.png)

     1. 片偏移  示例

        ![image-20210510163143356](计算机网络-韩立刚.assets/image-20210510163143356.png)

  8. **生存时间：**  生存时间字段常用的英文缩写是**TTL （Time To Live ）**，表明是数据包在网络中的寿命。 现在TTL 字段的功能改为“跳数限制” 。

  9. **协议占8 位**，协议字段指出此数据包携带的数据是使用何种协议，以便使目的主机的网络层知道应将数据部分上交给哪个处理过程。

     ![image-20210510163229634](计算机网络-韩立刚.assets/image-20210510163229634.png)

  10. **首部检验和占16 位**，这个字段只检验数据报的首部，但不包括数据部分。这是因为数据报每经过一个路由器，路由器都要重新计算一下首部检验和（一些字段，如生存时间、标志、片偏移等都可能发生变化）。不检验数据部分可减少计算的工作量。

  

### 7.1.3 实战：查看协议版本和首部长度

![image-20210510163441519](计算机网络-韩立刚.assets/image-20210510163441519.png)

![image-20210510163455770](计算机网络-韩立刚.assets/image-20210510163455770.png)



### 7.1.4 实战：给数据包设置区分服务字段

![image-20210510163518858](计算机网络-韩立刚.assets/image-20210510163518858.png)

![image-20210510163531468](计算机网络-韩立刚.assets/image-20210510163531468.png)



### 7.1.5 数据分片详解

- 在 在IP 层下面的每一种数据链路层都有其特有的帧格式，帧格式也定义了帧中数据字段的最大长度，数据字段最大长度称为最大传送单元MTU （Maximum Transfer Unit ）。当一个IP数 数据包封装成链路层的帧时，此数据包的总长度（即首部加上数据部分）一定不能超过下面的数据链路层的MTU 值。例如以太网就规定其MTU 值是1500 字节。若所传送的数据包长度超过数据链路层的MTU 值，就必须把过长的数据包进行分片处理。

- 在计算机A的数据链路层分片

  ![image-20210510163612377](计算机网络-韩立刚.assets/image-20210510163612377.png)

- 在R1 和R2 链路的数据链路层分片

  ![image-20210510163639098](计算机网络-韩立刚.assets/image-20210510163639098.png)

  

### 7.1.6 实战：捕获并观察数据包分片

```shell
C:\Users\win7>ping www.cctv.com -l 3500
正在 Ping cctv.xdwscache.ourglb0.com [111.11.31.114]  具有 3500
字节的数据:
来自 111.11.31.114  的回复:  字节=3500  时间=10ms TTL=128
来自 111.11.31.114  的回复:  字节=3500  时间=11ms TTL=128
来自 111.11.31.114  的回复:  字节=3500  时间=10ms TTL=128
来自 111.11.31.114  的回复:  字节=3500  时间=11ms TTL=128
```



![image-20210510163721971](计算机网络-韩立刚.assets/image-20210510163721971.png)

![image-20210510163740380](计算机网络-韩立刚.assets/image-20210510163740380.png)

![image-20210510163758373](计算机网络-韩立刚.assets/image-20210510163758373.png)

![image-20210510163815821](计算机网络-韩立刚.assets/image-20210510163815821.png)

![image-20210510163827894](计算机网络-韩立刚.assets/image-20210510163827894.png)





### 7.1.7 实战：查看和配置链路MTU

- 可以设置路由器接口的MTU。

  ![image-20210510163853227](计算机网络-韩立刚.assets/image-20210510163853227.png)

```shell
R1#show interfaces serial 1/0
Serial1/0 is up, line protocol is up
Hardware is M4T
Internet address is 172.16.0.1/24
MTU 1500 bytes, BW 1544 Kbit, DLY 20000 usec,

设置接口的MTU
R1(config)#interface serial 1/0
R1(config-if)#mtu 500
```



### 7.1.8 数据包生存时间（TTL ）详解

- 各种操作系统发送数据包，在网络首部都要给TTL 字段赋值，用来限制该数据包能够通过的路由器数量，下面列出一些操作系统发送数据包默认的TTL 值。

  ```
  Windows NT 4.0/2000/XP/2003 128
  MS Windows 95/98/NT 3.51 32
  Linux 64
  MacOS/MacTCP 2.0.x 60
  ```

  ![image-20210510164022971](计算机网络-韩立刚.assets/image-20210510164022971.png)

  

### 7.1.9 实战：指定ping 命令发送数据包的TTL值

- 虽然操作系统会给发送的数据包指默认的TTL 值，但是ping 命令允许我们使用参数-i 指定发送的ICMP 请求数据包的TTL 值。

- 一个路由器在转发数据包之前将该数据包的TTL 减1 ，如果减1 后TTL变为0 ，路由器就会丢弃该数据包，然后产生一个ICMP 响应数据包给发送者，说明TTL 耗尽。通过这种方式，你能够知道到达目标地址经过哪些路由器。

  ![image-20210510164105085](计算机网络-韩立刚.assets/image-20210510164105085.png)

  ```shell
  C:\Users\han>ping edu.51cto.com -i 2
  在 Ping yun.dns.51cto.com [120.55.239.108]  具有 32  字节的数据:
  来自 172.16.0.250  的回复: TTL  传输中过期。
  来自 172.16.0.250  的回复: TTL  传输中过期。
  来自 172.16.0.250  的回复: TTL  传输中过期。
  来自 172.16.0.250  的回复: TTL 
  ```

  ![image-20210510164151433](计算机网络-韩立刚.assets/image-20210510164151433.png)

  ![image-20210510164203235](计算机网络-韩立刚.assets/image-20210510164203235.png)

  

### 7.1.10 实战：抓包查看数据包的TTL变化

![image-20210510164216654](计算机网络-韩立刚.assets/image-20210510164216654.png)

![image-20210510164228619](计算机网络-韩立刚.assets/image-20210510164228619.png)



## 7.2 ICMP 协议

- ICMP 协议是TCP/IP 协议栈中的网络层的一个协议，ICMP是 是（Internet Control Message Protocol ）Internet 控制报文协议，用于在IP 主机、路由器之间传递控制消息。控制消息是指网络通不通、主机是否可达、路由是否可用等网络本身的消息。
- ICMP 报文是在IP 数据报内部被传输的，它封装在IP 数据报内。ICMP 报文通常被IP 层或更层协议（TCP 或UDP ）使用。一些ICMP 报文把差错报文返回给用户进程。

### 7.2.1抓包查看ICMP报文格式

- ICMP 报文分为：

  1. ICMP 请求报文
  2. ICMP 响应报文
  3. ICMP 差错报告报文

  ![image-20210510164337668](计算机网络-韩立刚.assets/image-20210510164337668.png)

- ICMP 请求报文

  ![image-20210510164412247](计算机网络-韩立刚.assets/image-20210510164412247.png)

  

- ICMP响应报文

  ![image-20210510164431747](计算机网络-韩立刚.assets/image-20210510164431747.png)

  

- ICMP报文类型和代码

  ![image-20210510164455925](计算机网络-韩立刚.assets/image-20210510164455925.png)

  1. **终点不可到达**  当路由器或主机没有到达目标地址的路由时，就丢弃该数据包，给源点发送终点不可到达报文。
  2. **源点抑制**  当路由器或主机由于拥塞而丢弃数据包时，就会向源点发送源点抑制报文，使源点知道应当降低数据包的发送速率。
  3. **时间超时**  当路由器收到生存时间为零的数据报时，除丢弃该数据报外，还要向源点发送时间超过报文。当终点在预先规定的时间内不能收到一个数据报的全部数据报片时，就把己收到的数据报片都丢弃，并向源点发送时间超过报文。
  4. **参数问题**  当路由器或目的主机收到的数据报的首部中有的字段的值不正确时，就丢弃该数据报，并向源点发送参数问题报文。
  5. **改变路由**（重定向）  路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器（可通过更好的路由）。

### 7.2.2 ICMP报文格式

- ICMP 报文的前4 个字节是统一的格式，共有三个字段：即类型、代码和检验和。接着4 个字节的内容与ICMP 的类型有关。

  ![image-20210510164842228](计算机网络-韩立刚.assets/image-20210510164842228.png)

- ICMP 差错报告报文的数据字段的内容

  ![image-20210510164905315](计算机网络-韩立刚.assets/image-20210510164905315.png)

### 7.2.3 ICMP差错报告报文-TTL过期

![image-20210510164955996](计算机网络-韩立刚.assets/image-20210510164955996.png)

### 7.2.4 ICMP差错报告报文-目标主机不可到达

![image-20210510165018275](计算机网络-韩立刚.assets/image-20210510165018275.png)

### 7.2.5 ICMP差错报告报文-路由重定向

![image-20210510165039773](计算机网络-韩立刚.assets/image-20210510165039773.png)

![image-20210510165049808](计算机网络-韩立刚.assets/image-20210510165049808.png)



### 7.2.6 ICMP差错报告报文-给程序返回错误消息

![image-20210510165112124](计算机网络-韩立刚.assets/image-20210510165112124.png)

- ICMP为应用程序返回差错报告

![image-20210510165137294](计算机网络-韩立刚.assets/image-20210510165137294.png)



## 7.3  使用ICMP 排除网络故障案例

### 7.3.1  使用ping 命令诊断网络故障

![image-20210510170630860](计算机网络-韩立刚.assets/image-20210510170630860.png)



### 7.3.2 使用ping 断定哪一段链路出现故障

![image-20210510170651043](计算机网络-韩立刚.assets/image-20210510170651043.png)

- 测试哪一段链路丢包

![image-20210510170718042](计算机网络-韩立刚.assets/image-20210510170718042.png)

- 断定是整个机房堵塞还是服务器网络堵塞

![image-20210510170733525](计算机网络-韩立刚.assets/image-20210510170733525.png)



### 7.3.3 使用tracert 跟踪数据包路径

-  Ping 命令并不能跟踪从源地址到目标地址沿途经过了哪些路由器，Windows 操作系统中的tracert 命令是路由跟踪实用程序，用于确定IP 数据报访问目标地址路径，能够帮助我们发现到达目标网络到底是哪一条链路出现了故障。Tracert  命令就是ping 命令的扩展，用 IP 报文生存时间 （TTL ）字和 段和 ICMP 差错报告报文来确定沿途经过的路由器。
- Tracert 工作原理如下图所示。

![image-20210510170827807](计算机网络-韩立刚.assets/image-20210510170827807.png)



### 7.3.4 使用pathping 跟踪数据包路径

- Pathping 是一个基于TCP/IP 的命令行工具，该命令不但可以跟踪数据包从源主机到目标主机所经过的路径，还可以统计计算机网络延时以及丢包率，帮助我们解决网络问题，跟踪数据包路径的原理和tracert 命令一样。

![image-20210510170910338](计算机网络-韩立刚.assets/image-20210510170910338.png)



## 7.4 ARP 协议

- ARP 协议的作用，将以太网中的计算机的IP 地址解析成MAC 地址。
- 点到点链路使用PPP 协议，不需要ARP 协议。

![image-20210510170936880](计算机网络-韩立刚.assets/image-20210510170936880.png)



### 7.4.1ARP协议的工作过程和安全隐患

- ARP 协议是建立在网络中各个主机互相信任的基础上的，计算机A 发送ARP 广播帧解析计算机C 的MAC 地址，同一个网段中的计算机都能够收到这个ARP 请求消息，任何一个主机都可以给计算机A 发送ARP 应答消息，可以告诉计算机A 一个错误的 的MAC 地址，计算机A 收到ARP 应答报文时并不会检测该报文的真实性，就会将其记入本机ARP 缓存，这就存在一个安全隐患--ARP

### 7.4.2 ARP欺骗之网络执法官

- 网络执法官软件可以控制以太网中的计算机通信

![image-20210510171040760](计算机网络-韩立刚.assets/image-20210510171040760.png)

- 查看解析的MAC地址

![image-20210510171055729](计算机网络-韩立刚.assets/image-20210510171055729.png)



### 7.4.3判断和防止ARP欺骗的方法

![image-20210510171120394](计算机网络-韩立刚.assets/image-20210510171120394.png)



## 7.5 IGMP 协议

### 7.5.1 什么是组播

- Internet  组管理协议称为 IGMP 协议（Internet Group Management Protocol ），是因特网协议家族中的一个组播协议。该协议运行在主机和组播路由器之间，IGMP协 协议是网络层协议。要想搞明白 白IGMP 协议的作用和用途，先要搞明白什么是组播通信，组播也称为多播。

![image-20210510171215161](计算机网络-韩立刚.assets/image-20210510171215161.png)

- 组播节省网络带宽
  - 流媒体服务器就像电视台，多播地址相当于不同的频道。可以使用两个组播地址向网络中发送两个课程的视频。网络的中的计算机绑定哪个多播地址就能收到哪个视频课程。

![image-20210510171242266](计算机网络-韩立刚.assets/image-20210510171242266.png)



### 7.5.2 组播IP 地址

- IP 地址中的D 类地址是组播地址。D 类IP 地址的前四位是1110 ，因此D类地址范围是`224.0.0.0 到239.255.255.255` 。我们就用每一个D 类地址标志一个多播组。

- 多播地址只能用于目的地址，而不能用于源地址。

- D 类地址中有一些是不能随意使用的，因为有的地址己经被IANA 指派为永久组地址了[RFC3330] 。例如：

  ```
  224.0.0.0 基地址（保留）
  224.0.0.1 在本子网上的所有参加多播的主机和路由器
  224.0.0.2 在本子网上的所有参加组播的路由器
  224.0.0.3 未指派
  224.0.0.4 DVMRP 路由器
  ……
  224.0.1.0 至238.255.255.255 全球范围都可使用的组播地址
  239.0.0.0 至239.255.255.255 限制在一个组织的范围
  ```

  

### 7.5.3 组播MAC 地址

- 目标地址是组播IP 地址的数据包到达以太网，就要使用组播MAC 地址封装，组播MAC 地址使用组播IP 地址构造。

- 为了支持IP  组播，因特网号码指派管理局IANA 已经为 Ethernet 的MAC 地址保留了一个组播地址区间：`01-00-5E-00-00-00  到 01-00-5E-7F-FF-FF` 。如图7-84 所示，组播MAC 地址48 位的MAC 地址中的高25 位是固定的，为了映射一个IP  多播地址到MAC层的组播地址，IP 多播地址的低23 位可以直接映射为MAC 层组播地址的低23 位。

  ![image-20210510171427558](计算机网络-韩立刚.assets/image-20210510171427558.png)

- 不同的组播IP地址可能构造出相同的多播MAC地址

  - 比如组播IP 地址224.128.64.32 ，如 下图 所示，使用上面的方法构造出的 的MAC 地址为01-00-5E-00-40-20。 

    ![image-20210510171533847](计算机网络-韩立刚.assets/image-20210510171533847.png)

  - 组播IP 地址224.0.64.32 ，如下图所示，使用上面的方法构造出的MAC地址也为01-00-5E-00-40-20。

    ![image-20210510171548109](计算机网络-韩立刚.assets/image-20210510171548109.png)

    

### 7.5.4 组播管理协议（IGMP）

-  IGMP 实现如下双向的功能：
  1. 主机通过IGMP 通知路由器希望接收或离开某个特定组播组的信息。
  2. 路由器通过IGMP 周期性地查询局域网内的组播组成员是否处于活动状态，实现所连网段组成员关系的收集与维护。

![image-20210510171632636](计算机网络-韩立刚.assets/image-20210510171632636.png)



## 7.6  实战：跨网段观看组播视频

### 7.6.1 搭建流媒体服务器



### 7.6.2 点播视频



### 7.6.3 访问多播视频

![image-20210510171720475](计算机网络-韩立刚.assets/image-20210510171720475.png)

- 配置路由器支持多播

  ```shell
  R1#config t
  R1(config)#ip multicast-routing
  R1(config)#interface fastEthernet 0/0
  R1(config-if)#ip pim dense-mode
  R1(config-if)#exit
  R1(config)#interface serial 2/0
  R1(config-if)#ip pim dense-mode
  R1(config-if)#^Z
  R1#
  ```

- 查看多播路由表

  ```shell
  R2#show ip mroute
  IP Multicast Routing Table
  Flags: D - Dense, S - Sparse, B - Bidir Group, s - SSM Group, C - Connected,
  L - Local, P - Pruned, R - RP-bit set, F - Register flag,
  T - SPT-bit set, J - Join SPT, M - MSDP created entry,
  X - Proxy Join Timer Running, A - Candidate for MSDP Advertisement,
  U - URD, I - Received Source Specific Host Report,
  Z - Multicast Tunnel, z - MDT-data group sender,
  Y - Joined MDT-data group, y - Sending to MDT-data group
  Outgoing interface flags: H - Hardware switched, A - Assert winner
  Timers: Uptime/Expires
  Interface state: Interface, Next-Hop or VCD, State/Mode
  (*, 239.255.255.250), 00:19:26/00:02:36, RP 0.0.0.0, flags: DC
  Incoming interface: Null, RPF nbr 0.0.0.0
  Outgoing interface list:
  Serial2/0, Forward/Dense, 00:18:57/00:00:00
  FastEthernet0/0, Forward/Dense, 00:19:26/00:00:00
  ```

### 7.6.4 跨网段多播

```shell
R2#debug ip igmp
*Mar 1 01:04:38.235: IGMP(0): Received Group record for group 239.192.44.166,
mode 2 from 192.168.80.111 for 0 sources
*Mar 1 01:04:38.239: IGMP(0): WAVL Insert group: 239.192.44.166 interface:
FastEthernet0/0Successful
*Mar 1 01:04:38.239: IGMP(0): Switching to EXCLUDE mode for 239.192.44.166 on
FastEthernet0/0
*Mar 1 01:05:06.487: IGMP(0): Send v2 general Query on FastEthernet0/0
*Mar 1 01:05:16.111: IGMP(0): Received v2 Report on FastEthernet0/0 from
192.168.80.111 for 239.192.44.166
*Mar 1 01:06:11.115: IGMP(0): Received Leave from 192.168.80.111
(FastEthernet0/0) for 239.192.44.166
*Mar 1 01:06:11.119: IGMP(0): Send v2 Query on FastEthernet0/0 for group
239.192.44.166
```





# 第8章 传输层

6小时18分钟27节

8-1 本章重点 07:16 
8-2 传输层两个协议应用场景 24:47 
8-3 传输层协议和应用层协议之间的关系 04:22 
8-4 服务和端口的关系 09:25 
8-5 安装服务查看侦听的端口 14:02 
8-6 使用telnet和端口扫描工具扫描远程服务器打开的端 10:06 
8-7 服务器和客户端的端口要求本地唯一 07:57 
8-8 更改服务使用的端口 15:14 
8-9 端口和网络安全 10:52 
8-10 Windows防火墙和TCPIP筛选实现网络安全 13:46 
8-11 UDP协议特点和首部格式 14:44 
8-12 TCP协议特点 17:56 
8-13 TCP报文首部字段 18:31 
8-14 TCP报文格式-标记位 20:53 
8-15 TCP可靠传输的实现-停止等待协议 07:42 
8-16 改进的停止等待协议-连续ARQ和滑动窗口 10:42 
8-17 以字节为单位的滑动窗口技术详解 14:57 
8-18 选择性确认SACK 17:48 
8-19 超时重传时间的调整 18:30 
8-20 TCP协议流量控制功能-发送端根据接收端的接收能力调 21:24 
8-21 TCP协议拥塞控制 14:42 

## 8.1 传输层的两个协议

## 8.2 用户数据报协议UDP

## 8.3 传输控制协议TCP

## 8.4 可靠传输

## 8.5 流量控制

## 8.6 拥塞控制

## 8.7 TCP连接管理



# 第9章 应用层协议

7小时44分钟40节

9-15 查看释放刷新IP地址以及抓包观察DHCP协议定义的四 07:20 
9-16 跨网段分配IP地址 06:56 
9-17 配置跨网段分配IP地址 11:13 
9-18 telnet协议 16:22 
9-19 Windows远程桌面协议RDP 10:32 
9-20 http协议和html文档 11:50 
9-21 定位全球资源-统一资源定位符URL 17:35 
9-22 很路径和相对路径 04:21 
9-23 创建Web站点 17:48 
9-24 HTTP协议的版本 09:50 
9-25 HTTP请求报文和响应报文 09:21 
9-26 HTTP请求报文-POST和GET方法 05:25 
9-27 http响应报文状态代码 04:59 
9-28 记录用户身份-Cookie 13:54 
9-29 通过web代理访问网站 14:37 
9-30 Web代理服务器应用场 25:40 
9-31 FTP协议主动模式被动模式 12:33 
9-32 更改FTP客户端主动模式被动模式 14:14 
9-33 抓包分析FTP数据包 15:19 
9-34 隔离用户的FTP 11:34 
9-35 收发电子邮件使用的协议 09:08 
9-36 配置邮件客户端收发电子邮件 10:13 
9-37 使用telnet直接发送邮件 14:38 
9-38 POP3协议和IMAP协议 03:26 
9-39 POP3协议和IMAP协议 20:07 
9-40 通过抓包工具分析SMTP协议和POP协议数据包格式 08:05 

## 9.1  域名系统DNS

## 9.2  动态主机配置协议DHCP

## 9.3 Telnet 协议

## 9.4  远程桌面协议（RDP） ）

## 9.5  超级文本传输协议HTTP

## 9.6  文件传输协议FTP

## 9.7  发送电子邮件的协议SMTP

## 9.8  接收电子邮件的协议POP3 和IMAP



# 第10章 网络安全

5小时34分钟18节

10-1 网络安全介绍OK 14:34 
10-2 网络安全4个威胁 20:34 
10-3 篡改和伪造 22:59 
10-4 病毒和木马 22:25 
10-5 对称加密 11:13 
10-6 非对称加密和数字签名 28:41 
10-7 证书颁发机构 14:26 
10-8 安装CA并申请证书和邮箱 26:50 
10-9 发送签名加密电子邮件 20:50 
10-10 安全套接字SSLOK 19:10 
10-11 配置网站使用SSL通信OK 17:23 
10-12 验证http不加密 08:06 
10-13 验证https的安全性 18:32 
10-14 使用抓包工具验证https安全性 06:27 
10-15 网络层安全IPSec介绍 20:04 
10-16 搭建IPSec实验环境 10:28 
10-17 配置IPSec 29:09 
10-18 数据链路层安全 22:39 



# 第11章 Internet上音频视频

1小时31分钟5节


11-1 安装流媒体服务器 15:46 
11-2 通过网站访问流媒体服务器上的视频 15:36 
11-3 流媒体实现现场直播OK 26:26 
11-4 IP电话OK 17:15 
11-5 Internet上的音频视频面临的问题 16:33 



# 第12章 无线网络

32分钟2节

12-1 创建临时网络 12:17 
12-2 无线网络 20:20 



# 第13章 IPv6

5小时48分钟22节


13-1 IPv6网络层协议 14:45 
13-2 IPv6改进 14:21 
13-3 IPv6基本首部和扩展首部 19:42 
13-4 IPv6地址格式 20:31 
13-5 使用IPv6访问网站 06:50 
13-6 实战1：无状态IPv6地址自动配置 23:17 
13-7 实战2：有状态IPv6地址自动配置 19:49 
13-8 使用接口物理地址构造IPv6地址接口ID 05:13 
13-9 实战3：配置IPv6静态路由 04:40 
13-10 实战4：IPv6动态路由-RIPng 09:42 
13-11 实战5：配置EIGRPv6支持IPv6 08:22 
13-12 实战6：配置OSPFv3支持IPv6 05:54 
13-13 实战7：IPv6和IPv4的共存技术-双协议6 33:58 
13-14 实战8：IPv4和IPv6共存技术-6to4隧道技术 23:35 
13-15 实战8：IPv4和IPv6共存技术-6to4隧道配置 09:35 
13-16 实战9：IPv4和IPv6共存技术-ISATAP隧道 20:17 
13-17 实战9：ISATAP隧道IPv4和IPv6配置通 16:38 
13-18 实战11：IPv4和IPv6共存技术-动态NAT-P 17:12 
13-19 实战10：IPv4和IPv6共存技术-NAT-PT 25:23 
13-20 验证NAT-PT 20:57 
13-21 动态NAT-PT配置 19:26 
13-22 配置ISATAP路由器 为Windows指定ISAT 08:34 

# 附录：

win命令

```powershell
netstat -aon|findstr "10010"
UDP127.0.0.1:10010*:*18308
tasklist|findstr "18308"
NVIDIA Web Helper.exe18308 Console1 14,544 K
```

